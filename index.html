<!DOCTYPE html>
<html lang="pt-ao">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#121212" id="theme-color-meta">
    <title>Pambala - Compre e venda em Angola</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.1/dist/browser-image-compression.js"></script>

    <style>
        :root {
            --accent-red: #E53935;
            --whatsapp-green: #25D366;
            --success-green: #4CAF50;
            --pending-orange: #FB8C00;
        }
        body[data-theme="light"] {
            --primary: #FF5722; --primary-light: #FF8A65; --bg-color: #F5F5F5; --card-color: #FFFFFF;
            --text-color: #212121; --text-secondary: #757575; --border-color: #E0E0E0; --header-color: #FFFFFF;
        }
        body[data-theme="dark"] {
            --primary: #FF6A00; --primary-light: #FFA726; --bg-color: #121212; --card-color: #1C1C1E;
            --text-color: #FFFFFF; --text-secondary: #AAAAAA; --border-color: #333333; --header-color: #1C1C1E;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; transition: background-color 0.3s, color 0.3s, border-color 0.3s; }
        body { background-color: var(--bg-color); color: var(--text-color); padding-bottom: 80px; }
        header { display: flex; justify-content: space-between; align-items: center; padding: 15px; background-color: var(--header-color); border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: 100; }
        .logo { font-weight: bold; font-size: 1.2rem; color: var(--primary); }
        .header-icons { display: flex; align-items: center; gap: 20px; }
        .header-icons i { cursor: pointer; font-size: 1.2rem; }
        .header-icons .user-avatar { width: 30px; height: 30px; border-radius: 50%; background-size: cover; background-position: center; cursor: pointer; border: 2px solid var(--primary); }
        .header-icons .cart-icon-wrapper { position: relative; }
        .cart-badge { position: absolute; top: -8px; right: -10px; background-color: var(--accent-red); color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 0.7rem; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 1px solid var(--bg-color); }
        .section-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 15px 0 15px; }
        .section-title { font-weight: bold; font-size: 1.1rem; padding: 15px; }
        .btn-vendor-switch { background-color: transparent; border: 1px solid var(--primary); color: var(--primary); padding: 6px 12px; border-radius: 20px; cursor: pointer; font-size: 0.8rem; font-weight: bold; display: none; }
        .category-icons-section { padding: 15px; }
        .category-icons-container { display: flex; overflow-x: auto; gap: 15px; padding-bottom: 10px; scrollbar-width: none; }
        .category-icons-container::-webkit-scrollbar { display: none; }
        .category-icon { flex: 0 0 80px; display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; text-align: center; }
        .category-icon div { width: 60px; height: 60px; background-color: var(--card-color); border: 1px solid var(--border-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: var(--primary); }
        .category-icon span { font-size: 0.8rem; color: var(--text-secondary); }
        .category-icon.active div { background-color: var(--primary); color: #FFF; }
        .category-icon.active span { color: var(--primary); font-weight: bold; }
        .featured-carousel { padding: 0 15px 15px; }
        .carousel-container { display: flex; overflow-x: auto; gap: 15px; padding-bottom: 10px; scrollbar-width: thin; scrollbar-color: var(--primary) var(--card-color); }
        .featured-card { flex: 0 0 280px; background-color: var(--card-color); border-radius: 10px; overflow: hidden; position: relative; border: 1px solid var(--border-color); display: flex; flex-direction: column; }
        .product-card { background-color: var(--card-color); border-radius: 10px; overflow: hidden; position: relative; border: 1px solid var(--border-color); display: flex; flex-direction: column; }
        .featured-image, .product-image { width: 100%; padding-top: 100%; background-size: cover; background-position: center; cursor: pointer; }
        .featured-info, .product-info { padding: 10px; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .featured-title, .product-title { font-size: 0.9rem; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; display: -webkit-box; min-height: 2.7em; }
        .featured-price, .product-price { font-weight: bold; margin-top: 8px; color: var(--primary); }
        .featured-title { font-size: 1rem; font-weight: bold; white-space: nowrap; text-overflow: ellipsis; }
        .featured-price { font-size: 0.9rem; color: var(--primary-light); }
        .btn-add-to-cart { background-color: var(--primary); color: white; border: none; padding: 8px; border-radius: 5px; cursor: pointer; margin-top: 10px; font-weight: bold; font-size: 0.8rem; width: 100%; }
        .filter-controls { display: flex; flex-wrap: wrap; gap: 10px; padding: 15px; background-color: var(--header-color); border-top: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color);}
        .filter-controls input, .filter-controls select { flex: 1 1 150px; padding: 10px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-color); font-size: 0.9rem; }
        .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; padding: 15px; }
        .favorite-icon { position: absolute; top: 10px; right: 10px; font-size: 1.3rem; color: #FFF; background-color: rgba(0,0,0,0.4); border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 2; }
        .favorite-icon.is-favorite { color: var(--accent-red); }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; display: flex; justify-content: space-around; background-color: var(--header-color); padding-top: 10px; padding-bottom:10px; z-index: 100; border-top: 1px solid var(--border-color); }
        .nav-item { display: flex; flex-direction: column; align-items: center; font-size: 0.75rem; cursor: pointer; color: var(--text-secondary); }
        .nav-item.active { color: var(--primary); }
        .nav-item i { font-size: 1.2rem; margin-bottom: 3px; }
        .auth-modal, .cart-modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; }
        .auth-modal { background-color: var(--bg-color); overflow-y: auto; padding: 15px; }
        .cart-modal-overlay { background-color: rgba(0,0,0,0.7); align-items: flex-end; justify-content: center; }
        .cart-modal { background-color: var(--bg-color); width: 100%; max-height: 90vh; border-radius: 15px 15px 0 0; display: flex; flex-direction: column; animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .cart-header { padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); }
        .cart-header h2 { font-size: 1.2rem; }
        .close-btn { font-size: 1.5rem; cursor: pointer; color: var(--text-secondary); }
        .cart-items-container { overflow-y: auto; padding: 15px; flex-grow: 1; }
        .cart-item { display: flex; gap: 15px; align-items: center; margin-bottom: 15px; }
        .cart-item img { width: 70px; height: 70px; object-fit: cover; border-radius: 8px; }
        .cart-item-info { flex-grow: 1; }
        .cart-item-title { font-weight: bold; font-size: 0.9rem; }
        .cart-item-price { color: var(--primary); font-size: 0.9rem; margin: 5px 0; }
        .quantity-controls { display: flex; align-items: center; gap: 10px; }
        .quantity-controls button { background-color: var(--card-color); border: 1px solid var(--border-color); width: 25px; height: 25px; border-radius: 50%; cursor: pointer; font-weight: bold; }
        .cart-footer { padding: 15px; border-top: 1px solid var(--border-color); }
        .cart-total { display: flex; justify-content: space-between; font-weight: bold; font-size: 1.1rem; margin-bottom: 15px; }
        .btn-checkout { background-color: var(--primary); color: white; width: 100%; padding: 14px; font-size: 1rem; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; }
        .auth-container { width: 100%; max-width: 420px; margin: 0 auto; }
        .auth-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .auth-header .logo { font-size: 1.5rem; }
        .auth-header .close-btn { font-size: 1.8rem; cursor: pointer; color: var(--text-secondary); }
        .auth-tabs { display: flex; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; margin-bottom: 2rem; }
        .tab-link { flex: 1; padding: 12px; text-align: center; background-color: transparent; color: var(--text-secondary); cursor: pointer; border: none; font-size: 1rem; }
        .tab-link.active { background-color: var(--primary); color: #FFFFFF; font-weight: bold; }
        .auth-view { display: none; } .auth-view.active { display: block; } .auth-title { font-size: 1.5rem; font-weight: bold; margin-bottom: 1.5rem; }
        .form-group { margin-bottom: 1.2rem; }
        .form-group label { display: block; margin-bottom: 8px; font-size: 0.9rem; color: var(--text-secondary); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; background-color: var(--card-color); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-color); font-size: 1rem; }
        .form-group input[type="file"] { padding: 5px; }
        .form-group textarea { resize: vertical; min-height: 100px; }
        .form-group .phone-group { display: flex; }
        .form-group .phone-prefix { padding: 12px; border: 1px solid var(--border-color); border-right: none; border-radius: 8px 0 0 8px; background-color: var(--card-color); }
        .btn-primary { background-color: var(--primary); color: #FFFFFF; width: 100%; padding: 14px; font-size: 1rem; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; margin-top: 1rem; }
        .btn-primary:disabled, .btn-secondary:disabled { background-color: var(--text-secondary); cursor: not-allowed; opacity: 0.7; }
        .btn-secondary { background-color: transparent; color: var(--primary); border: 1px solid var(--primary); width: 100%; padding: 14px; font-size: 1rem; font-weight: bold; border-radius: 8px; cursor: pointer; }
        #loader { display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000; background-color: rgba(0, 0, 0, 0.7); justify-content: center; align-items: center; } .spinner { width: 50px; height: 50px; border: 5px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: var(--primary); animation: spin 1s linear infinite; } @keyframes spin { to { transform: rotate(360deg); } }
        .vendor-panel-container{padding:15px}
        .list-item{background-color:var(--card-color);padding:15px;border-radius:8px;margin-bottom:10px;display:flex;align-items:center;gap:15px}
        .list-item img{width:60px;height:60px;border-radius:4px;object-fit:cover}
        .list-item-info{flex:1}
        .list-item-actions{display:flex;gap:10px}
        .list-item-actions button, .list-item .btn-review {background:transparent;border:none;color:var(--text-color);font-size:1.2rem;cursor:pointer}
        .list-item-actions .btn-delete{color:var(--accent-red)}
        .list-item .btn-review { font-size: 0.8rem; border: 1px solid var(--primary); color: var(--primary); padding: 5px 10px; border-radius: 20px; white-space: nowrap;}
        .list-item .btn-review:disabled { border-color: var(--text-secondary); color: var(--text-secondary); cursor: not-allowed;}
        .review-card{background-color:var(--card-color);padding:15px;border-radius:8px;margin-bottom:10px; border-left: 3px solid var(--primary);}
        .review-stars{color:var(--primary-light)}
        .contact-modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:3000}
        .contact-modal{background:var(--card-color);padding:25px;border-radius:12px;width:90%;max-width:350px;text-align:center; animation: slideUp 0.3s ease-out; }
        .contact-modal h3{margin-bottom:20px}
        .contact-buttons{display:flex;flex-direction:column;gap:15px}
        .btn-contact{padding:12px;border-radius:8px;text-decoration:none;font-weight:bold;display:flex;align-items:center;justify-content:center;gap:10px;color:white;border:none;font-size:1rem;}
        .btn-whatsapp{background-color:var(--whatsapp-green);}
        .btn-call{background-color:var(--primary);}
        .rating-stars { display: flex; justify-content: center; margin-bottom: 1rem; direction: rtl; }
        .rating-stars input[type="radio"] { display: none; }
        .rating-stars label { font-size: 2rem; color: #444; cursor: pointer; transition: color 0.2s; }
        .rating-stars input[type="radio"]:checked ~ label, .rating-stars label:hover, .rating-stars label:hover ~ label { color: var(--primary-light); }
        .forgot-password a, .terms-group a, .auth-footer-link a { color: var(--primary); text-decoration: none; }
        .auth-footer-link { text-align: center; margin-top: 1.5rem; }
        .info-message { text-align: center; color: var(--text-secondary); padding: 40px 15px; }
        .account-actions { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
        .status-badge { padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; color: #FFF; }
        .status-badge.pending { background-color: var(--pending-orange); }
        .status-badge.active { background-color: var(--success-green); }
        @media (min-width: 768px) {
            body { padding-bottom: 0; }
            main, .bottom-nav { max-width: 1200px; margin: 0 auto; }
            .bottom-nav { position: static; border-radius: 10px; margin-top: 20px; }
            .products-grid { grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); }
            .featured-card { flex: 0 0 350px; }
            .account-actions { flex-direction: row; }
        }
        @media (min-width: 1024px) {
            .filter-controls { flex-wrap: nowrap; }
        }
    </style>
</head>
<body data-theme="dark">
    <div id="loader"><div class="spinner"></div></div>

    <div id="app-container">
        <header>
            <div class="logo"><i class="fas fa-shopping-bag"></i> PAMBALA</div>
            <div class="header-icons">
                <i class="fas fa-moon" id="theme-toggle-btn"></i>
                <div class="cart-icon-wrapper">
                    <i class="fas fa-shopping-cart" id="cart-icon"></i>
                    <span class="cart-badge" id="cart-count-badge" style="display: none;">0</span>
                </div>
                <div id="user-icon-container">
                    <i class="far fa-user" id="user-icon"></i>
                </div>
            </div>
        </header>

        <main>
            <div id="buyer-panels-container">
                <div id="buyer-panel">
                    <div class="featured-carousel"><div class="section-title" style="padding: 15px 0 10px 0;">Destaques</div><div class="carousel-container" id="featured-container"></div></div>
                    <div class="category-icons-section"><div class="category-icons-container" id="category-icons-container"></div></div>
                    <div class="filter-controls">
                        <input type="search" id="search-input" placeholder="O que procuras?">
                        <select id="category-filter"><option value="">Todas as Categorias</option></select>
                        <select id="location-filter"><option value="">Todas as Localizações</option></select>
                    </div>
                    <div class="section-header" style="padding-top: 0px;"><div class="section-title" style="padding-top: 0px;">Todos os Produtos</div><button id="switch-to-vendor-btn" class="btn-vendor-switch">Modo Vendedor</button></div>
                    <div class="products-grid" id="products-container"></div>
                </div>
                <div id="purchases-panel" style="display: none;"><div class="section-title">Minhas Compras</div><div id="purchases-container" class="vendor-panel-container"></div></div>
                <div id="favorites-panel" style="display: none;"><div class="section-title">Meus Favoritos</div><div class="products-grid" id="favorites-container"></div></div>
                <div id="account-panel" class="vendor-panel-container" style="display: none;">
                    <h2 class="section-title" style="padding: 0 0 15px 0;">Minha Conta</h2>
                    <div class="list-item">
                        <div class="list-item-info">
                            <strong>Meu Saldo</strong>
                            <div id="user-balance" style="color: var(--primary); font-size: 1.2rem; font-weight: bold;">AOA 0.00</div>
                        </div>
                    </div>
                    <div class="account-actions">
                         <button id="top-up-btn" class="btn-primary" style="margin-top:0;">Recarregar</button>
                         <button id="withdraw-btn" class="btn-secondary" style="margin-top:0;">Levantar</button>
                    </div>
                     <div class="list-item" style="margin-top:20px;">
                        <div class="list-item-info">
                            <strong>Meu Código de Padrinho</strong>
                            <p style="font-size: 0.8rem; color: var(--text-secondary);">Partilhe e ganhe quando um afilhado comprar um selo!</p>
                            <strong id="user-referral-code" style="font-size: 1.1rem; letter-spacing: 2px; margin-top: 5px;">-</strong>
                        </div>
                        <button id="copy-code-btn" class="btn-review" style="font-size: 1rem;"><i class="fas fa-copy"></i></button>
                    </div>

                    <div id="verification-section" style="margin-top: 10px; padding: 15px; background-color: var(--card-color); border-radius: 8px;">
                        <h3 id="verification-title">Verificação de Conta</h3>
                        <p style="font-size: 0.9rem; color: var(--text-secondary); margin: 10px 0;" id="verification-status-text">Aumente a confiança na comunidade.</p>
                        <div id="verification-actions" class="account-actions">
                        </div>
                    </div>

                     <div class="list-item" style="margin-top:20px; cursor:pointer;" id="logout-btn">
                        <div class="list-item-info"><strong style="color: var(--accent-red);">Terminar Sessão</strong></div>
                        <i class="fas fa-sign-out-alt" style="color: var(--accent-red);"></i>
                    </div>
                </div>
            </div>

            <div id="vendor-panels-container" style="display: none;">
                <div id="vendor-home-panel" class="vendor-panel-container"><h2 class="section-title" style="padding: 0 0 15px 0;">Meus Anúncios</h2><div id="my-products-list"></div></div>
                <div id="vendor-add-product-panel" class="vendor-panel-container" style="display: none;">
                    <h2 class="section-title" id="add-edit-form-title">Adicionar Novo Produto</h2>
                    <form id="add-product-form"><input type="hidden" id="product-id-input"><div class="form-group"><label for="product-name">Nome</label><input type="text" id="product-name" required></div><div class="form-group"><label for="product-description">Descrição</label><textarea id="product-description" required></textarea></div><div class="form-group"><label for="product-price">Preço (AOA)</label><input type="number" id="product-price" required></div><div class="form-group"><label for="product-category">Categoria</label><select id="product-category" required></select></div><div class="form-group"><label for="product-location">Localização</label><select id="product-location" required></select></div><div class="form-group"><label for="product-image-url">URL da Imagem</label><input type="url" id="product-image-url" placeholder="https://exemplo.com/imagem.jpg" required></div><div class="form-group" style="flex-direction: row; align-items: center; gap: 10px; display: flex;"><input type="checkbox" id="product-is-featured" style="width: auto;"><label for="product-is-featured" style="margin-bottom: 0;">Destaque</label></div><button type="submit" class="btn-primary" id="add-edit-form-button">Publicar</button></form>
                </div>
                <div id="vendor-messages-panel" style="display: none; padding: 0;"></div>
                <div id="vendor-profile-panel" class="vendor-panel-container" style="display: none;"><h2 class="section-title" style="padding: 0 0 15px 0;">Meu Perfil</h2><h3 style="font-size: 1rem; color: var(--text-secondary); margin-bottom: 15px;">Avaliações Recebidas</h3><div id="my-reviews-list"></div></div>
            </div>
        </main>

        <div id="buyer-bottom-nav" class="bottom-nav">
            <div class="nav-item active" data-panel="buyer-panel"><i class="fas fa-home"></i><div>Início</div></div>
            <div class="nav-item" data-panel="purchases-panel"><i class="fas fa-receipt"></i><div>Compras</div></div>
            <div class="nav-item" data-panel="favorites-panel"><i class="far fa-heart"></i><div>Favoritos</div></div>
            <div class="nav-item" data-panel="account-panel" id="buyer-account-nav"><i class="far fa-user"></i><div>Conta</div></div>
        </div>
        <div id="vendor-bottom-nav" class="bottom-nav" style="display: none;">
            <div class="nav-item active" data-panel="vendor-home-panel"><i class="fas fa-store"></i><div>Início</div></div>
            <div class="nav-item" data-panel="vendor-add-product-panel"><i class="fas fa-plus-circle"></i><div>Adicionar</div></div>
            <div class="nav-item" data-panel="vendor-messages-panel"><i class="fas fa-comments"></i><div>Mensagens</div></div>
            <div class="nav-item" data-panel="vendor-profile-panel"><i class="fas fa-user-cog"></i><div>Perfil</div></div>
        </div>
    </div>

    <div id="cart-modal-overlay" class="cart-modal-overlay">
        <div class="cart-modal">
            <div class="cart-header">
                <h2>Meu Carrinho</h2>
                <div class="close-btn" id="close-cart-btn">&times;</div>
            </div>
            <div class="cart-items-container" id="cart-items-container"></div>
            <div class="cart-footer">
                <div class="cart-total">
                    <span>Total</span>
                    <span id="cart-total">AOA 0</span>
                </div>
                <button class="btn-checkout" id="checkout-btn">Finalizar Compra</button>
            </div>
        </div>
    </div>

    <div id="auth-modal" class="auth-modal">
        <div class="auth-container">
            <div class="auth-header">
                <div class="logo">PAMBALA</div>
                <div class="close-btn" id="close-auth-btn">&times;</div>
            </div>
            <div class="auth-tabs" id="main-auth-tabs">
                <button class="tab-link main-tab active" data-tab="login-view">Entrar</button>
                <button class="tab-link main-tab" data-tab="register-view">Cadastrar</button>
            </div>
            <div id="login-view" class="auth-view active">
                <h2 class="auth-title">Bem-vindo</h2>
                <form id="login-form">
                    <div class="form-group">
                        <label for="login-email">E-mail</label>
                        <input type="email" id="login-email" required>
                    </div>
                    <div class="form-group">
                        <label for="login-password">Senha</label>
                        <input type="password" id="login-password" required>
                    </div>
                    <div class="forgot-password"><a href="#" id="forgot-password-link">Esqueceu a senha?</a></div>
                    <button type="submit" class="btn-primary">Entrar</button>
                </form>
            </div>
            <div id="register-view" class="auth-view">
                <form id="register-form">
                    <div class="auth-tabs">
                        <button type="button" class="tab-link account-type-btn active" data-type="buyer">Comprador</button>
                        <button type="button" class="tab-link account-type-btn" data-type="vendor">Vendedor</button>
                        <input type="hidden" id="register-account-type" value="buyer">
                    </div>
                    <div class="form-group"><label>Nome</label><input type="text" id="register-name" required></div>
                    <div class="form-group"><label>E-mail</label><input type="email" id="register-email" required></div>
                    <div class="form-group"><label>Telefone</label><div class="phone-group"><span class="phone-prefix">+244</span><input type="tel" id="register-phone" placeholder="9XX XXX XXX" required></div></div>
                    <div class="form-group"><label>Nº do BI</label><input type="text" id="register-id" required></div>
                    <div class="form-group"><label>Morada (Província)</label><select id="register-address" required></select></div>
                    <div class="form-group"><label>Senha</label><input type="password" id="register-password" required></div>
                    <div class="form-group"><label>Confirmar Senha</label><input type="password" id="register-confirm" required></div>
                    <div class="form-group"><label>Cód. de Padrinho (Opcional)</label><input type="text" id="register-referral-code"></div>
                    <div class="terms-group"><input type="checkbox" id="register-terms" required><label for="register-terms">Concordo com os <a href="#">Termos</a> e <a href="#">Privacidade</a></label></div>
                    <button type="submit" class="btn-primary">Criar Conta</button>
                </form>
            </div>
            <div id="password-recovery-view" class="auth-view">
                <h2 class="auth-title">Recuperar Senha</h2>
                <p style="color:var(--text-secondary);margin-bottom:1.5rem">Insira o seu e-mail para receber um link de recuperação.</p>
                <form id="recovery-form">
                    <div class="form-group">
                        <label for="recovery-email">E-mail</label>
                        <input type="email" id="recovery-email" required>
                    </div>
                    <button type="submit" class="btn-primary">Enviar Link</button>
                </form>
                <div class="auth-footer-link"><a href="#" id="back-to-login-link">Voltar para o Login</a></div>
            </div>
            <div id="update-password-view" class="auth-view">
                <h2 class="auth-title">Definir Nova Senha</h2>
                <p style="color:var(--text-secondary);margin-bottom:1.5rem">Crie uma nova senha para a sua conta. Deve ter no mínimo 6 caracteres.</p>
                <form id="update-password-form">
                    <div class="form-group">
                        <label for="update-password">Nova Senha</label>
                        <input type="password" id="update-password" required minlength="6">
                    </div>
                    <button type="submit" class="btn-primary">Atualizar Senha</button>
                </form>
            </div>
        </div>
    </div>
    <div id="contact-modal-overlay" class="contact-modal-overlay"><div class="contact-modal"><h3 id="contact-modal-title">Contactar Vendedor</h3><div class="contact-buttons"><a href="#" id="whatsapp-btn" class="btn-contact btn-whatsapp" target="_blank"><i class="fab fa-whatsapp"></i> WhatsApp</a><a href="#" id="call-btn" class="btn-contact btn-call"><i class="fas fa-phone"></i> Ligar</a></div><button id="close-contact-modal-btn" style="margin-top:20px;background:none;border:none;color:var(--text-secondary)">Fechar</button></div></div>
    <div id="review-modal-overlay" class="contact-modal-overlay"><div class="contact-modal"><h3>Avaliar Produto</h3><form id="review-form"><input type="hidden" id="review-order-id" name="order-id"><input type="hidden" id="review-product-id" name="product-id"><input type="hidden" id="review-seller-id" name="seller-id"><div class="form-group"><div class="rating-stars"><input type="radio" id="star5" name="rating" value="5" required><label for="star5">★</label><input type="radio" id="star4" name="rating" value="4"><label for="star4">★</label><input type="radio" id="star3" name="rating" value="3"><label for="star3">★</label><input type="radio" id="star2" name="rating" value="2"><label for="star2">★</label><input type="radio" id="star1" name="rating" value="1"><label for="star1">★</label></div></div><div class="form-group"><label for="review-comment">Comentário</label><textarea id="review-comment" name="comment"></textarea></div><button type="submit" class="btn-primary">Enviar Avaliação</button></form><button id="close-review-modal-btn" style="margin-top:20px;background:none;border:none;color:var(--text-secondary)">Fechar</button></div></div>
    <div id="top-up-modal-overlay" class="contact-modal-overlay"><div class="contact-modal"><h3>Recarregar Saldo</h3><p style="font-size:0.9rem; color: var(--text-secondary); margin-bottom: 15px;">Simulação de recarga via Unitel Money.</p><form id="top-up-form"><div class="form-group"><label for="top-up-amount">Valor (AOA)</label><input type="number" id="top-up-amount" required min="100" placeholder="Ex: 5000"></div><div class="form-group"><label for="top-up-phone">Nº de Telefone (Unitel Money)</label><input type="tel" id="top-up-phone" required placeholder="9XX XXX XXX"></div><button type="submit" class="btn-primary">Pagar</button></form><button id="close-top-up-modal-btn" style="margin-top:20px;background:none;border:none;color:var(--text-secondary)">Cancelar</button></div></div>
    <div id="withdraw-modal-overlay" class="contact-modal-overlay"><div class="contact-modal"><h3>Levantar Saldo</h3><p style="font-size:0.9rem; color: var(--text-secondary); margin-bottom: 15px;">O pedido será processado pela nossa equipa.</p><p style="font-size:1rem; margin-bottom: 15px;">Saldo Disponível: <strong id="withdraw-available-balance" style="color: var(--primary);">AOA 0.00</strong></p><form id="withdraw-form"><div class="form-group"><label for="withdraw-amount">Valor a Levantar (AOA)</label><input type="number" id="withdraw-amount" required min="1000"></div><div class="form-group"><label for="withdraw-details">Detalhes de Pagamento</label><input type="text" id="withdraw-details" required placeholder="Nº de conta ou telemóvel"></div><button type="submit" class="btn-primary">Solicitar Levantamento</button></form><button id="close-withdraw-modal-btn" style="margin-top:20px;background:none;border:none;color:var(--text-secondary)">Cancelar</button></div></div>

    <div id="verification-modal-overlay" class="contact-modal-overlay">
        <div class="contact-modal" style="max-width: 450px; text-align: left;">
            <h3 id="verification-modal-title">Candidatura de Verificação</h3>
            <p style="font-size:0.9rem; color: var(--text-secondary); margin-bottom: 20px;">Envie os seus documentos para análise.</p>
            <form id="verification-form">
                <input type="hidden" id="verification-type-input">
                <div class="form-group">
                    <label for="verification-name">Nome Completo (como no BI)</label>
                    <input type="text" id="verification-name" required>
                </div>
                <div class="form-group">
                    <label for="verification-bi-front">BI (Frente)</label>
                    <input type="file" id="verification-bi-front" accept="image/*" required>
                </div>
                <div class="form-group">
                    <label for="verification-bi-back">BI (Verso)</label>
                    <input type="file" id="verification-bi-back" accept="image/*" required>
                </div>
                 <div class="form-group">
                    <label for="verification-avatar">Foto de Perfil</label>
                    <input type="file" id="verification-avatar" accept="image/*" required>
                </div>
                <button type="submit" class="btn-primary">Submeter Candidatura</button>
            </form>
            <button id="close-verification-modal-btn" style="margin-top:20px;background:none;border:none;color:var(--text-secondary); width: 100%; text-align: center;">Cancelar</button>
        </div>
    </div>

    <script>
        const supabaseUrl = 'https://hztwtjgxhfrognqyjxaq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh6dHd0amd4aGZyb2ducXlqeGFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwMjcxNzMsImV4cCI6MjA3MDYwMzE3M30.PBqfdKkkFSXicHQBjfZQEDt0C33Y88nLF1tpovurNXk';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        const imageCompression = window.imageCompression;

        const state = {
            currentUser: null,
            userProfile: null,
            userFavorites: new Set(),
            cart: [],
            currentFilters: { name: '', categoryId: '', locationId: '' }
        };
        let searchTimeout;

        const DOM = {
            loader: document.getElementById('loader'),
            userIconContainer: document.getElementById('user-icon-container'),
            appContainer: document.getElementById('app-container'),
            authModal: document.getElementById('auth-modal'),
            closeAuthBtn: document.getElementById('close-auth-btn'),
            themeToggleBtn: document.getElementById('theme-toggle-btn'),
            cartIcon: document.getElementById('cart-icon'),
            cartCountBadge: document.getElementById('cart-count-badge'),
            cartModalOverlay: document.getElementById('cart-modal-overlay'),
            closeCartBtn: document.getElementById('close-cart-btn'),
            cartItemsContainer: document.getElementById('cart-items-container'),
            cartTotal: document.getElementById('cart-total'),
            checkoutBtn: document.getElementById('checkout-btn'),
            buyerPanelsContainer: document.getElementById('buyer-panels-container'),
            vendorPanelsContainer: document.getElementById('vendor-panels-container'),
            productsContainer: document.getElementById('products-container'),
            favoritesContainer: document.getElementById('favorites-container'),
            purchasesContainer: document.getElementById('purchases-container'),
            loginForm: document.getElementById('login-form'),
            registerForm: document.getElementById('register-form'),
            recoveryForm: document.getElementById('recovery-form'),
            updatePasswordForm: document.getElementById('update-password-form'),
            switchToVendorBtn: document.getElementById('switch-to-vendor-btn'),
            featuredContainer: document.getElementById('featured-container'),
            searchInput: document.getElementById('search-input'),
            categoryFilter: document.getElementById('category-filter'),
            locationFilter: document.getElementById('location-filter'),
            buyerBottomNav: document.getElementById('buyer-bottom-nav'),
            vendorBottomNav: document.getElementById('vendor-bottom-nav'),
            myProductsList: document.getElementById('my-products-list'),
            myReviewsList: document.getElementById('my-reviews-list'),
            addProductForm: document.getElementById('add-product-form'),
            addEditFormTitle: document.getElementById('add-edit-form-title'),
            addEditFormButton: document.getElementById('add-edit-form-button'),
            productIdInput: document.getElementById('product-id-input'),
            contactModalOverlay: document.getElementById('contact-modal-overlay'),
            contactModalTitle: document.getElementById('contact-modal-title'),
            whatsappBtn: document.getElementById('whatsapp-btn'),
            callBtn: document.getElementById('call-btn'),
            closeContactModalBtn: document.getElementById('close-contact-modal-btn'),
            reviewModalOverlay: document.getElementById('review-modal-overlay'),
            reviewForm: document.getElementById('review-form'),
            closeReviewModalBtn: document.getElementById('close-review-modal-btn'),
            logoutBtn: document.getElementById('logout-btn'),
            forgotPasswordLink: document.getElementById('forgot-password-link'),
            backToLoginLink: document.getElementById('back-to-login-link'),
            mainAuthTabs: document.getElementById('main-auth-tabs'),
            accountTypeBtns: document.querySelectorAll('.account-type-btn'),
            authTabBtns: document.querySelectorAll('.main-tab'),
            categoryIconsContainer: document.getElementById('category-icons-container'),
            userBalance: document.getElementById('user-balance'),
            userReferralCode: document.getElementById('user-referral-code'),
            copyCodeBtn: document.getElementById('copy-code-btn'),
            topUpBtn: document.getElementById('top-up-btn'),
            withdrawBtn: document.getElementById('withdraw-btn'),
            topUpModalOverlay: document.getElementById('top-up-modal-overlay'),
            withdrawModalOverlay: document.getElementById('withdraw-modal-overlay'),
            closeTopUpModalBtn: document.getElementById('close-top-up-modal-btn'),
            closeWithdrawModalBtn: document.getElementById('close-withdraw-modal-btn'),
            topUpForm: document.getElementById('top-up-form'),
            withdrawForm: document.getElementById('withdraw-form'),
            withdrawAvailableBalance: document.getElementById('withdraw-available-balance'),
            verificationSection: document.getElementById('verification-section'),
            verificationTitle: document.getElementById('verification-title'),
            verificationStatusText: document.getElementById('verification-status-text'),
            verificationActions: document.getElementById('verification-actions'),
            verificationModalOverlay: document.getElementById('verification-modal-overlay'),
            verificationModalTitle: document.getElementById('verification-modal-title'),
            verificationForm: document.getElementById('verification-form'),
            verificationTypeInput: document.getElementById('verification-type-input'),
            closeVerificationModalBtn: document.getElementById('close-verification-modal-btn'),
        };

        function showLoader() { DOM.loader.style.display = 'flex'; }
        function hideLoader() { DOM.loader.style.display = 'none'; }
        function formatCurrency(amount) { return new Intl.NumberFormat('pt-AO', { style: 'currency', currency: 'AOA', minimumFractionDigits: 2 }).format(amount || 0); }

        async function compressImage(file) {
            if (!file) return null;
            console.log(`Original file size ${file.size / 1024 / 1024} MB`);
            const options = {
                maxSizeMB: 1,
                maxWidthOrHeight: 1024,
                useWebWorker: true,
            }
            try {
                const compressedFile = await imageCompression(file, options);
                console.log(`Compressed file size ${compressedFile.size / 1024 / 1024} MB`);
                return compressedFile;
            } catch (error) {
                console.error('Error compressing image:', error);
                return file;
            }
        }

        function setTheme(theme) { document.body.dataset.theme = theme; localStorage.setItem('pambala-theme', theme); DOM.themeToggleBtn.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon'; document.getElementById('theme-color-meta').setAttribute('content', theme === 'dark' ? '#121212' : '#F5F5F5'); }
        function toggleTheme() { setTheme(document.body.dataset.theme === 'dark' ? 'light' : 'dark'); }
        function loadTheme() { const savedTheme = localStorage.getItem('pambala-theme') || (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'); setTheme(savedTheme); }

        function switchAuthView(viewToShow) {
            document.querySelectorAll('.auth-view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
            const viewElement = document.getElementById(viewToShow);
            if (viewElement) viewElement.classList.add('active');
            const tabElement = document.querySelector(`.main-tab[data-tab="${viewToShow}"]`);
            if (tabElement) tabElement.classList.add('active');
            DOM.mainAuthTabs.style.display = (viewToShow === 'login-view' || viewToShow === 'register-view') ? 'flex' : 'none';
        }
        function openAuthModal(view = 'login-view') { DOM.authModal.style.display = 'block'; switchAuthView(view); }
        function closeAuthModal() { DOM.authModal.style.display = 'none'; }

        async function login(email, password) {
            showLoader();
            try {
                const { error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) throw error;
            } catch (error) {
                hideLoader();
                alert('Erro no login: ' + error.message);
            }
        }

        async function signOut() {
            showLoader();
            await supabase.auth.signOut();
            hideLoader();
        }

        async function handleRegister(e) {
            e.preventDefault();
            const form = DOM.registerForm;
            const phoneInput = form.querySelector('#register-phone').value.trim();
            const password = form.querySelector('#register-password').value;
            const angolanPhoneRegex = /^9[1-59]\d{7}$/;
            if (!angolanPhoneRegex.test(phoneInput)) { alert('Por favor, insira um número de telefone de Angola válido (9 dígitos, começando com 9).'); return; }
            if (password.length < 6) { alert('A senha deve ter no mínimo 6 caracteres.'); return; }
            if (password !== form.querySelector('#register-confirm').value) { alert('As senhas não coincidem!'); return; }
            if (!form.querySelector('#register-terms').checked) { alert('Deve concordar com os Termos e Privacidade.'); return; }

            showLoader();
            try {
                const { data: authData, error: authError } = await supabase.auth.signUp({
                    email: form.querySelector('#register-email').value,
                    password: password
                });
                if (authError) throw authError;

                const profileData = {
                    id: authData.user.id,
                    full_name: form.querySelector('#register-name').value,
                    phone: `+244${phoneInput}`,
                    id_number: form.querySelector('#register-id').value,
                    address: form.querySelector('#register-address').selectedOptions[0].text,
                    account_type: form.querySelector('#register-account-type').value,
                    referral_code: 'PAM' + Math.random().toString(36).substring(2, 8).toUpperCase()
                };

                const referralCode = form.querySelector('#register-referral-code').value.trim();
                if (referralCode) {
                    const { data: referrer, error: referrerError } = await supabase.from('profiles').select('id').eq('referral_code', referralCode).single();
                    if (referrer && !referrerError) {
                        profileData.referred_by = referrer.id;
                    }
                }

                const { error: profileError } = await supabase.from('profiles').insert(profileData);
                if (profileError) throw profileError;

                alert('Registo concluído! Verifique o seu e-mail para confirmar a conta.');
                switchAuthView('login-view');
            } catch (error) {
                alert('Erro no registo: ' + error.message);
            } finally {
                hideLoader();
            }
        }

        async function handlePasswordRecovery(e) { e.preventDefault(); const email = DOM.recoveryForm.querySelector('#recovery-email').value; showLoader(); const { error } = await supabase.auth.resetPasswordForEmail(email, { redirectTo: window.location.origin }); hideLoader(); if (error) { alert("Erro ao enviar link: " + error.message); } else { alert("Link de recuperação enviado! Verifique o seu e-mail."); switchAuthView('login-view'); } }
        async function handleUpdatePassword(e) { e.preventDefault(); const newPassword = DOM.updatePasswordForm.querySelector('#update-password').value; if (newPassword.length < 6) { alert("A senha deve ter no mínimo 6 caracteres."); return; } showLoader(); const { error } = await supabase.auth.updateUser({ password: newPassword }); hideLoader(); if (error) { alert("Erro ao atualizar a senha: " + error.message); } else { alert("Senha atualizada com sucesso!"); await supabase.auth.signOut(); } }

        function saveCartToLocalStorage() { localStorage.setItem('pambala-cart', JSON.stringify(state.cart)); }
        function loadCartFromLocalStorage() { const savedCart = localStorage.getItem('pambala-cart'); if (savedCart) { state.cart = JSON.parse(savedCart); } renderCart(); }

        function addToCart(product) { const existingItem = state.cart.find(item => item.id === product.id); if (existingItem) { existingItem.quantity++; } else { state.cart.push({ ...product, quantity: 1 }); } saveCartToLocalStorage(); renderCart(); }
        function updateCartQuantity(productId, newQuantity) { const item = state.cart.find(item => item.id === productId); if (item) { if (newQuantity <= 0) { removeFromCart(productId); } else { item.quantity = newQuantity; saveCartToLocalStorage(); renderCart(); } } }
        function removeFromCart(productId) { state.cart = state.cart.filter(item => item.id !== productId); saveCartToLocalStorage(); renderCart(); }
        function clearCart() { state.cart = []; saveCartToLocalStorage(); renderCart(); }

        function renderCart() {
            DOM.cartItemsContainer.innerHTML = '';
            let total = 0;
            let totalItems = 0;
            if (state.cart.length === 0) {
                DOM.cartItemsContainer.innerHTML = '<p class="info-message">O seu carrinho está vazio.</p>';
            } else {
                state.cart.forEach(item => {
                    total += item.price * item.quantity;
                    DOM.cartItemsContainer.innerHTML += `
                        <div class="cart-item">
                            <img src="${item.image_url}" alt="${item.name}">
                            <div class="cart-item-info">
                                <div class="cart-item-title">${item.name}</div>
                                <div class="cart-item-price">${formatCurrency(item.price)}</div>
                                <div class="quantity-controls">
                                    <button data-id="${item.id}" class="quantity-decrease">-</button>
                                    <span>${item.quantity}</span>
                                    <button data-id="${item.id}" class="quantity-increase">+</button>
                                </div>
                            </div>
                            <button class="close-btn remove-from-cart" data-id="${item.id}">&times;</button>
                        </div>`;
                });
            }
            state.cart.forEach(item => totalItems += item.quantity);
            DOM.cartTotal.textContent = formatCurrency(total);
            DOM.cartCountBadge.textContent = totalItems;
            DOM.cartCountBadge.style.display = totalItems > 0 ? 'flex' : 'none';
            DOM.checkoutBtn.disabled = totalItems === 0;
        }

        async function fetchAndPopulate(tableName, selectElementIds, valueField = 'id', textField = 'name') {
            const { data, error } = await supabase.from(tableName).select(`${valueField}, ${textField}`);
            if (error) { console.error(`Error fetching ${tableName}:`, error); return; }
            const selectElements = Array.isArray(selectElementIds) ? selectElementIds.map(id => document.getElementById(id)) : [document.getElementById(selectElementIds)];
            selectElements.forEach(select => {
                if (select) {
                    const firstOption = select.options[0];
                    select.innerHTML = '';
                    if (firstOption) select.appendChild(firstOption);
                    data.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item[valueField];
                        option.textContent = item[textField];
                        select.appendChild(option);
                    });
                }
            });
        }

        async function fetchAndDisplayCategories() {
            const { data, error } = await supabase.from('categories').select('id, name, icon_class');
            if(error) { console.error("Error fetching categories:", error); return; }
            DOM.categoryIconsContainer.innerHTML = '';
            data.forEach(cat => {
                DOM.categoryIconsContainer.innerHTML += `
                    <div class="category-icon" data-category-id="${cat.id}">
                        <div><i class="fas ${cat.icon_class || 'fa-tag'}"></i></div>
                        <span>${cat.name}</span>
                    </div>
                `;
            });
        }

        async function handleAddOrEditProduct(e) {
            e.preventDefault();
            if (!state.currentUser) { alert("Você precisa estar logado como vendedor."); return; }
            showLoader();
            const form = DOM.addProductForm;
            const productId = DOM.productIdInput.value;
            const productData = {
                name: form.querySelector('#product-name').value, description: form.querySelector('#product-description').value, price: parseFloat(form.querySelector('#product-price').value),
                category_id: parseInt(form.querySelector('#product-category').value), location_id: parseInt(form.querySelector('#product-location').value), image_url: form.querySelector('#product-image-url').value,
                is_featured: form.querySelector('#product-is-featured').checked, user_id: state.currentUser.id,
            };

            let error;
            if (productId) {
                const { error: updateError } = await supabase.from('products').update(productData).eq('id', productId);
                error = updateError;
            } else {
                const { error: insertError } = await supabase.from('products').insert([productData]);
                error = insertError;
            }
            hideLoader();

            if (error) { alert("Erro ao salvar produto: " + error.message); } 
            else { alert(`Produto ${productId ? 'atualizado' : 'publicado'} com sucesso!`); form.reset(); DOM.productIdInput.value = ''; renderVendorPanel('vendor-home-panel'); }
        }

        async function fetchUserProfile(user) {
            const { data, error } = await supabase.from('profiles').select('*').eq('id', user.id).single();
            if (error) {
                console.error('Erro ao buscar perfil:', error);
                return null;
            }
            return data;
        }

        async function fetchInitialData(user) {
            state.currentUser = user;
            const [profile, favorites] = await Promise.all([
                fetchUserProfile(user),
                supabase.from('favorites').select('product_id').eq('user_id', user.id)
            ]);
            state.userProfile = profile;
            if (favorites.data) {
                state.userFavorites = new Set(favorites.data.map(fav => fav.product_id));
            }
            updateUIForUser();
            await fetchAndDisplayProducts();
            await fetchAndDisplayFeatured();
        }

        function updateUIForUser() {
            const loggedIn = !!state.currentUser;
            const isSeller = state.userProfile?.account_type === 'vendor';

            DOM.userIconContainer.innerHTML = '';
            if (loggedIn && state.userProfile?.avatar_url) {
                const avatar = document.createElement('div');
                avatar.className = 'user-avatar';
                avatar.style.backgroundImage = `url(${state.userProfile.avatar_url})`;
                avatar.onclick = () => document.querySelector('#buyer-bottom-nav .nav-item[data-panel="account-panel"]').click();
                DOM.userIconContainer.appendChild(avatar);
            } else {
                const icon = document.createElement('i');
                icon.className = loggedIn ? 'fas fa-user-check' : 'far fa-user';
                icon.onclick = () => { if (state.currentUser) { document.querySelector('#buyer-bottom-nav .nav-item[data-panel="account-panel"]').click(); } else { openAuthModal('login-view'); } };
                DOM.userIconContainer.appendChild(icon);
            }

            DOM.switchToVendorBtn.style.display = loggedIn && isSeller && state.userProfile.verification_status === 'ativo_vendedor' ? 'block' : 'none';

            if (loggedIn) { 
                updateAccountPanel(); 
            }
            renderOverallPanel(false); 
        }

        function updateAccountPanel() {
            if (!state.userProfile) return;
            DOM.userBalance.textContent = formatCurrency(state.userProfile.balance);
            DOM.userReferralCode.textContent = state.userProfile.referral_code || 'N/A';
            DOM.withdrawBtn.disabled = !state.userProfile.balance || state.userProfile.balance <= 0;

            const status = state.userProfile.verification_status;
            const actionsContainer = DOM.verificationActions;
            actionsContainer.innerHTML = '';
            let statusText = '';
            let title = 'Verificação de Conta';

            switch(status) {
                case 'pendente':
                    title = 'Candidatura em Análise';
                    statusText = 'A sua candidatura está a ser revista pela nossa equipa.';
                    actionsContainer.innerHTML = `<span class="status-badge pending">Pendente</span>`;
                    break;
                case 'ativo_vendedor':
                    title = 'Vendedor Verificado';
                    statusText = 'A sua conta está verificada para vender na plataforma.';
                    actionsContainer.innerHTML = `<span class="status-badge active"><i class="fas fa-shield-alt"></i> Vendedor</span>`;
                    break;
                case 'ativo_comprador_confianca':
                    title = 'Comprador de Confiança';
                    statusText = 'Tem um selo de confiança, tornando as suas interações mais seguras.';
                    actionsContainer.innerHTML = `<span class="status-badge active"><i class="fas fa-check-circle"></i> Confiança</span>`;
                    break;
                case 'rejeitado':
                    title = 'Candidatura Rejeitada';
                    statusText = 'Houve um problema com a sua candidatura. Por favor, contacte o suporte.';
                    break;
                case 'aprovado_aguarda_pagamento':
                    title = 'Candidatura Aprovada!';
                    statusText = 'Parabéns! A sua candidatura foi aprovada. Efetue o pagamento para ativar o seu selo.';
                    const sealType = state.userProfile.verification_type;
                    const price = sealType === 'seller' ? 2000 : 1500;
                    actionsContainer.innerHTML = `<button id="pay-seal-btn" class="btn-primary" style="margin-top:0;">Pagar Selo - ${formatCurrency(price)}</button>`;
                    break;
                default: 
                    statusText = 'Torne-se um membro verificado para aumentar a confiança e desbloquear funcionalidades.';
                    actionsContainer.innerHTML = `
                        <button class="btn-primary" data-seal-type="seller" style="margin-top:0;">Selo de Vendedor (2000 AOA)</button>
                        <button class="btn-secondary" data-seal-type="buyer" style="margin-top:0;">Selo de Confiança (1500 AOA)</button>
                    `;
                    break;
            }
            DOM.verificationTitle.textContent = title;
            DOM.verificationStatusText.textContent = statusText;
        }


        function renderOverallPanel(isSellerMode) {
            DOM.buyerPanelsContainer.style.display = isSellerMode ? 'none' : 'block';
            DOM.vendorPanelsContainer.style.display = isSellerMode ? 'block' : 'none';
            DOM.buyerBottomNav.style.display = isSellerMode ? 'none' : 'flex';
            DOM.vendorBottomNav.style.display = isSellerMode ? 'flex' : 'none';

            if (isSellerMode) { renderVendorPanel('vendor-home-panel'); } 
            else { renderBuyerPanel('buyer-panel'); }
        }

        function renderBuyerPanel(panelId) {
            document.querySelectorAll('#buyer-panels-container > div').forEach(p => p.style.display = 'none');
            const panel = document.getElementById(panelId);
            if(panel) panel.style.display = 'block';

            if (panelId === 'buyer-panel') { fetchAndDisplayProducts(); fetchAndDisplayFeatured(); } 
            else if (panelId === 'favorites-panel') { fetchAndDisplayFavorites(); } 
            else if (panelId === 'purchases-panel') { fetchAndDisplayPurchases(); } 
            else if (panelId === 'account-panel') { updateAccountPanel(); }
        }

        function renderVendorPanel(panelId) {
             document.querySelectorAll('#vendor-panels-container > div').forEach(p => p.style.display = 'none');
            const panel = document.getElementById(panelId);
            if (panel) {
                panel.style.display = 'block';
                if (panelId === 'vendor-home-panel') fetchMyProducts();
                if (panelId === 'vendor-profile-panel') fetchMyReviews();
                if (panelId === 'vendor-add-product-panel') {
                    DOM.addEditFormTitle.textContent = 'Adicionar Novo Produto';
                    DOM.addEditFormButton.textContent = 'Publicar';
                    DOM.addProductForm.reset();
                    DOM.productIdInput.value = '';
                }
            }
        }

        function renderProductCard(product) {
            const isFavorite = state.userFavorites.has(product.id);
            const isFeatured = product.is_featured;
            const cardClass = isFeatured ? 'featured-card' : 'product-card';
            const imageClass = isFeatured ? 'featured-image' : 'product-image';
            const infoClass = isFeatured ? 'featured-info' : 'product-info';
            const titleClass = isFeatured ? 'featured-title' : 'product-title';
            const priceClass = isFeatured ? 'featured-price' : 'product-price';

            return `
                <div class="${cardClass}" data-product-id="${product.id}">
                    <div class="favorite-icon ${isFavorite ? 'is-favorite fas' : 'far'} fa-heart" data-product-id="${product.id}"></div>
                    <div class="${imageClass}" style="background-image: url('${product.image_url || ''}')"></div>
                    <div class="${infoClass}">
                        <div>
                            <div class="${titleClass}">${product.name}</div>
                            <div class="${priceClass}">${formatCurrency(product.price)}</div>
                        </div>
                        <button class="btn-add-to-cart" data-product-id="${product.id}">Adicionar</button>
                    </div>
                </div>`;
        }

        async function fetchAndDisplayProducts() { /* Implementação existente */ }
        async function fetchAndDisplayFeatured() { /* Implementação existente */ }
        async function fetchAndDisplayFavorites() { /* Implementação existente */ }
        async function fetchMyProducts() { /* Implementação existente */ }
        async function fetchMyReviews() { /* Implementação existente */ }
        async function fetchAndDisplayPurchases() { /* Implementação existente */ }

        async function openContactModal(productId) {
            const { data: product, error } = await supabase.from('products').select('name, profiles(full_name, phone)').eq('id', productId).single();
            if (error || !product) { alert('Não foi possível carregar os detalhes do vendedor.'); return; }
            DOM.contactModalTitle.textContent = `Contactar ${product.profiles.full_name}`;
            const phone = product.profiles.phone.replace(/\D/g, '');
            DOM.whatsappBtn.href = `https://wa.me/${phone}`;
            DOM.callBtn.href = `tel:+${phone}`;
            DOM.contactModalOverlay.style.display = 'flex';
        }

        function openReviewModal(orderId, productId, sellerId) {
            DOM.reviewForm.reset();
            DOM.reviewForm.querySelector('#review-order-id').value = orderId;
            DOM.reviewForm.querySelector('#review-product-id').value = productId;
            DOM.reviewForm.querySelector('#review-seller-id').value = sellerId;
            DOM.reviewModalOverlay.style.display = 'flex';
        }

        function openTopUpModal() {
            DOM.topUpForm.reset();
            if (state.userProfile && state.userProfile.phone) {
                DOM.topUpForm.querySelector('#top-up-phone').value = state.userProfile.phone.replace('+244', '');
            }
            DOM.topUpModalOverlay.style.display = 'flex';
        }

        async function handleTopUp(e) { e.preventDefault(); /* Implementação existente */ }
        function openWithdrawModal() { /* Implementação existente */ }
        async function handleWithdraw(e) { e.preventDefault(); /* Implementação existente */ }
        async function handleReviewSubmit(e) { e.preventDefault(); /* Implementação existente */ }

        async function toggleFavorite(productId) {
            if (!state.currentUser) { openAuthModal(); return; }
            const isFavorite = state.userFavorites.has(productId);
            const favoriteIcons = document.querySelectorAll(`.favorite-icon[data-product-id="${productId}"]`);

            if (isFavorite) {
                const { error } = await supabase.from('favorites').delete().match({ user_id: state.currentUser.id, product_id: productId });
                if (!error) {
                    state.userFavorites.delete(productId);
                    favoriteIcons.forEach(icon => { icon.classList.replace('fas', 'far'); icon.classList.remove('is-favorite'); });
                }
            } else {
                const { error } = await supabase.from('favorites').insert({ user_id: state.currentUser.id, product_id: productId });
                if (!error) {
                    state.userFavorites.add(productId);
                    favoriteIcons.forEach(icon => { icon.classList.replace('far', 'fas'); icon.classList.add('is-favorite'); });
                }
            }
        }

        async function deleteProduct(productId) {
            if (!confirm("Tem a certeza que quer apagar este produto? Esta ação não pode ser revertida.")) return;
            showLoader();
            const { error } = await supabase.from('products').delete().eq('id', productId);
            hideLoader();
            if(error) { alert("Erro ao apagar produto: " + error.message); }
            else { fetchMyProducts(); }
        }

        function editProduct(productId) { /* Implementação existente */ }

        function openVerificationModal(sealType) {
            DOM.verificationForm.reset();
            DOM.verificationTypeInput.value = sealType;
            const title = sealType === 'seller' ? 'Candidatura a Vendedor Verificado' : 'Obter Selo de Confiança';
            DOM.verificationModalTitle.textContent = title;
            DOM.verificationForm.querySelector('#verification-name').value = state.userProfile.full_name;
            DOM.verificationModalOverlay.style.display = 'flex';
        }

        async function handleVerificationSubmit(e) {
            e.preventDefault();
            showLoader();

            const form = DOM.verificationForm;
            const sealType = DOM.verificationTypeInput.value;
            const userId = state.currentUser.id;

            const biFrontFile = await compressImage(form.querySelector('#verification-bi-front').files[0]);
            const biBackFile = await compressImage(form.querySelector('#verification-bi-back').files[0]);
            const avatarFile = await compressImage(form.querySelector('#verification-avatar').files[0]);

            if (!biFrontFile || !biBackFile || !avatarFile) {
                hideLoader();
                alert('Por favor, envie todos os ficheiros necessários.');
                return;
            }

            const ocrName = prompt("SIMULAÇÃO DE OCR:\nPor favor, confirme o nome completo encontrado no seu BI.", state.userProfile.full_name);
            if (!ocrName) {
                hideLoader();
                alert("A confirmação do nome é necessária.");
                return;
            }

            try {
                const timestamp = Date.now();
                const { data: biFrontData, error: biFrontError } = await supabase.storage.from('documents').upload(`${userId}/bi_front_${timestamp}.jpg`, biFrontFile);
                if (biFrontError) throw biFrontError;

                const { data: biBackData, error: biBackError } = await supabase.storage.from('documents').upload(`${userId}/bi_back_${timestamp}.jpg`, biBackFile);
                if (biBackError) throw biBackError;

                const { data: avatarData, error: avatarError } = await supabase.storage.from('avatars').upload(`${userId}/avatar_${timestamp}.jpg`, avatarFile);
                if (avatarError) throw avatarError;

                const { data: { publicUrl: biFrontPublicUrl } } = supabase.storage.from('documents').getPublicUrl(biFrontData.path);
                const { data: { publicUrl: biBackPublicUrl } } = supabase.storage.from('documents').getPublicUrl(biBackData.path);
                const { data: { publicUrl: avatarPublicUrl } } = supabase.storage.from('avatars').getPublicUrl(avatarData.path);

                const { error: docError } = await supabase.from('verification_documents').insert({
                    user_id: userId,
                    bi_frente_url: biFrontPublicUrl,
                    bi_verso_url: biBackPublicUrl,
                });
                if (docError) throw docError;

                const { data: profileUpdate, error: profileError } = await supabase
                    .from('profiles')
                    .update({
                        full_name: ocrName,
                        avatar_url: avatarPublicUrl,
                        verification_status: 'pendente',
                        verification_type: sealType
                    })
                    .eq('id', userId)
                    .select()
                    .single();

                if (profileError) throw profileError;

                state.userProfile = profileUpdate;
                updateAccountPanel();
                updateUIForUser();
                DOM.verificationModalOverlay.style.display = 'none';
                alert('Candidatura submetida com sucesso! Será notificado após a nossa análise.');

            } catch (error) {
                alert('Erro ao submeter a candidatura: ' + error.message);
            } finally {
                hideLoader();
            }
        }

        function initEventListeners() {
            DOM.themeToggleBtn.addEventListener('click', toggleTheme);
            DOM.closeAuthBtn.addEventListener('click', closeAuthModal);
            DOM.loginForm.addEventListener('submit', (e) => { e.preventDefault(); login(DOM.loginForm.querySelector('#login-email').value, DOM.loginForm.querySelector('#login-password').value); });
            DOM.registerForm.addEventListener('submit', handleRegister);
            DOM.logoutBtn.addEventListener('click', signOut);
            DOM.recoveryForm.addEventListener('submit', handlePasswordRecovery);
            DOM.updatePasswordForm.addEventListener('submit', handleUpdatePassword);
            DOM.addProductForm.addEventListener('submit', handleAddOrEditProduct);
            DOM.closeContactModalBtn.addEventListener('click', () => DOM.contactModalOverlay.style.display = 'none');
            DOM.forgotPasswordLink.addEventListener('click', (e) => { e.preventDefault(); switchAuthView('password-recovery-view'); });
            DOM.backToLoginLink.addEventListener('click', (e) => { e.preventDefault(); switchAuthView('login-view'); });
            DOM.accountTypeBtns.forEach(btn => { btn.addEventListener('click', () => { DOM.accountTypeBtns.forEach(b => b.classList.remove('active')); btn.classList.add('active'); document.getElementById('register-account-type').value = btn.dataset.type; }); });
            DOM.authTabBtns.forEach(btn => { btn.addEventListener('click', () => { const view = btn.dataset.tab; if(view) switchAuthView(view); }); });
            DOM.cartIcon.addEventListener('click', () => DOM.cartModalOverlay.style.display = 'flex');
            DOM.closeCartBtn.addEventListener('click', () => DOM.cartModalOverlay.style.display = 'none');
            document.body.addEventListener('click', async (e) => {
                const productCard = e.target.closest('[data-product-id]');
                if (e.target.classList.contains('btn-add-to-cart')) {
                    if (productCard) {
                        showLoader();
                        const { data } = await supabase.from('products').select('*').eq('id', productCard.dataset.productId).single();
                        hideLoader();
                        if(data) addToCart(data);
                    }
                } else if (e.target.closest('.product-image, .featured-image')) {
                    if(productCard) openContactModal(productCard.dataset.productId);
                } else if (e.target.closest('.favorite-icon')) {
                    toggleFavorite(parseInt(e.target.closest('.favorite-icon').dataset.productId));
                } else if (e.target.closest('.btn-edit')) {
                    editProduct(parseInt(e.target.closest('.btn-edit').dataset.productId));
                } else if (e.target.closest('.btn-delete')) {
                    deleteProduct(parseInt(e.target.closest('.btn-delete').dataset.productId));
                } else if (e.target.closest('.category-icon')) {
                    const catIcon = e.target.closest('.category-icon');
                    const catId = catIcon.dataset.categoryId;
                    state.currentFilters.categoryId = catId;
                    DOM.categoryFilter.value = catId;
                    fetchAndDisplayProducts();
                    document.querySelectorAll('.category-icon').forEach(i => i.classList.remove('active'));
                    catIcon.classList.add('active');
                } else if (e.target.closest('.btn-review')) {
                    const btn = e.target.closest('.btn-review');
                    openReviewModal(btn.dataset.orderId, btn.dataset.productId, btn.dataset.sellerId);
                }
            });
            DOM.cartItemsContainer.addEventListener('click', (e) => { const id = parseInt(e.target.dataset.id); if (!id) return; if (e.target.classList.contains('quantity-increase')) { const item = state.cart.find(i => i.id === id); if(item) updateCartQuantity(id, item.quantity + 1); } else if (e.target.classList.contains('quantity-decrease')) { const item = state.cart.find(i => i.id === id); if(item) updateCartQuantity(id, item.quantity - 1); } else if (e.target.classList.contains('remove-from-cart')) { removeFromCart(id); } });
            document.querySelectorAll('#buyer-bottom-nav .nav-item').forEach(item => { item.addEventListener('click', () => { if (!state.currentUser && item.dataset.panel !== 'buyer-panel') { openAuthModal(); return; } document.querySelectorAll('#buyer-bottom-nav .nav-item').forEach(i => i.classList.remove('active')); item.classList.add('active'); renderBuyerPanel(item.dataset.panel); }); });
            document.querySelectorAll('#vendor-bottom-nav .nav-item').forEach(item => { item.addEventListener('click', () => { document.querySelectorAll('#vendor-bottom-nav .nav-item').forEach(i => i.classList.remove('active')); item.classList.add('active'); renderVendorPanel(item.dataset.panel); }); });
            DOM.switchToVendorBtn.addEventListener('click', () => renderOverallPanel(true));
            DOM.searchInput.addEventListener('input', () => { clearTimeout(searchTimeout); searchTimeout = setTimeout(() => { state.currentFilters.name = DOM.searchInput.value.trim(); fetchAndDisplayProducts(); }, 500); });
            DOM.categoryFilter.addEventListener('change', () => { state.currentFilters.categoryId = DOM.categoryFilter.value; fetchAndDisplayProducts(); });
            DOM.locationFilter.addEventListener('change', () => { state.currentFilters.locationId = DOM.locationFilter.value; fetchAndDisplayProducts(); });
            DOM.copyCodeBtn.addEventListener('click', () => { if(state.userProfile?.referral_code) navigator.clipboard.writeText(state.userProfile.referral_code).then(() => alert('Código de Padrinho copiado!')); });
            DOM.reviewForm.addEventListener('submit', handleReviewSubmit);
            DOM.closeReviewModalBtn.addEventListener('click', () => DOM.reviewModalOverlay.style.display = 'none');
            DOM.checkoutBtn.addEventListener('click', () => alert("Funcionalidade de checkout em implementação. Requer Edge Functions para segurança."));
            DOM.topUpBtn.addEventListener('click', openTopUpModal);
            DOM.withdrawBtn.addEventListener('click', openWithdrawModal);
            DOM.closeTopUpModalBtn.addEventListener('click', () => DOM.topUpModalOverlay.style.display = 'none');
            DOM.closeWithdrawModalBtn.addEventListener('click', () => DOM.withdrawModalOverlay.style.display = 'none');
            DOM.topUpForm.addEventListener('submit', handleTopUp);
            DOM.withdrawForm.addEventListener('submit', handleWithdraw);
            DOM.verificationActions.addEventListener('click', (e) => {
                if(e.target.matches('button[data-seal-type]')) {
                    openVerificationModal(e.target.dataset.sealType);
                } else if (e.target.matches('#pay-seal-btn')) {
                    alert("A funcionalidade de pagamento de selo requer uma função de backend segura para ser implementada.");
                }
            });
            DOM.verificationForm.addEventListener('submit', handleVerificationSubmit);
            DOM.closeVerificationModalBtn.addEventListener('click', () => DOM.verificationModalOverlay.style.display = 'none');
        }

        async function initApp() {
            showLoader();
            loadTheme();
            loadCartFromLocalStorage();
            initEventListeners();
            await Promise.all([
                fetchAndPopulate('locations', ['register-address', 'product-location', 'location-filter']),
                fetchAndPopulate('categories', ['product-category', 'category-filter']),
                fetchAndDisplayCategories()
            ]);

            supabase.auth.onAuthStateChange(async (event, session) => {
                hideLoader();
                if (event === 'PASSWORD_RECOVERY') {
                    openAuthModal('update-password-view');
                } else if (event === 'SIGNED_IN') {
                    await fetchInitialData(session.user);
                    closeAuthModal();
                } else if (event === 'SIGNED_OUT') {
                    state.currentUser = null;
                    state.userProfile = null;
                    state.userFavorites.clear();
                    updateUIForUser();
                    await fetchAndDisplayProducts();
                    await fetchAndDisplayFeatured();
                }
            });

            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                 updateUIForUser();
                 await fetchAndDisplayProducts();
                 await fetchAndDisplayFeatured();
                 hideLoader();
            }
        }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
