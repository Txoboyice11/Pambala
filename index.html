<!DOCTYPE html>
<html lang="pt-ao">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#121212" id="theme-color-meta">
    <title>Pambala - Compre e venda em Angola</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.1/dist/browser-image-compression.js"></script>

    <style>
        :root {
            --accent-red: #E53935;
            --whatsapp-green: #25D366;
            --success-green: #4CAF50;
            --pending-orange: #FB8C00;
        }
        body[data-theme="light"] {
            --primary: #FF5722; --primary-light: #FF8A65; --bg-color: #F5F5F5; --card-color: #FFFFFF;
            --text-color: #212121; --text-secondary: #757575; --border-color: #E0E0E0; --header-color: #FFFFFF;
        }
        body[data-theme="dark"] {
            --primary: #FF6A00; --primary-light: #FFA726; --bg-color: #121212; --card-color: #1C1C1E;
            --text-color: #FFFFFF; --text-secondary: #AAAAAA; --border-color: #333333; --header-color: #1C1C1E;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; transition: background-color 0.3s, color 0.3s, border-color 0.3s; }
        body { background-color: var(--bg-color); color: var(--text-color); padding-bottom: 80px; }
        header { display: flex; justify-content: space-between; align-items: center; padding: 15px; background-color: var(--header-color); border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: 100; }
        .logo { font-weight: bold; font-size: 1.2rem; color: var(--primary); }
        .header-icons { display: flex; align-items: center; gap: 20px; }
        .header-icons i { cursor: pointer; font-size: 1.2rem; }
        .header-icons .user-avatar { width: 30px; height: 30px; border-radius: 50%; background-size: cover; background-position: center; cursor: pointer; border: 2px solid var(--primary); }
        .header-icons .cart-icon-wrapper { position: relative; }
        .cart-badge { position: absolute; top: -8px; right: -10px; background-color: var(--accent-red); color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 0.7rem; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 1px solid var(--bg-color); }
        .section-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 15px 0 15px; }
        .section-title { font-weight: bold; font-size: 1.1rem; padding: 15px; }
        .btn-vendor-switch { background-color: transparent; border: 1px solid var(--primary); color: var(--primary); padding: 6px 12px; border-radius: 20px; cursor: pointer; font-size: 0.8rem; font-weight: bold; display: none; }
        .category-icons-section { padding: 15px; }
        .category-icons-container { display: flex; overflow-x: auto; gap: 15px; padding-bottom: 10px; scrollbar-width: none; }
        .category-icons-container::-webkit-scrollbar { display: none; }
        .category-icon { flex: 0 0 80px; display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; text-align: center; }
        .category-icon div { width: 60px; height: 60px; background-color: var(--card-color); border: 1px solid var(--border-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: var(--primary); }
        .category-icon span { font-size: 0.8rem; color: var(--text-secondary); }
        .category-icon.active div { background-color: var(--primary); color: #FFF; }
        .category-icon.active span { color: var(--primary); font-weight: bold; }
        .featured-carousel { padding: 0 15px 15px; }
        .carousel-container { display: flex; overflow-x: auto; gap: 15px; padding-bottom: 10px; scrollbar-width: thin; scrollbar-color: var(--primary) var(--card-color); }
        .featured-card { flex: 0 0 280px; background-color: var(--card-color); border-radius: 10px; overflow: hidden; position: relative; border: 1px solid var(--border-color); display: flex; flex-direction: column; }
        .product-card { background-color: var(--card-color); border-radius: 10px; overflow: hidden; position: relative; border: 1px solid var(--border-color); display: flex; flex-direction: column; }
        .featured-image, .product-image { width: 100%; padding-top: 100%; background-size: cover; background-position: center; cursor: pointer; }
        .featured-info, .product-info { padding: 10px; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .featured-title, .product-title { font-size: 0.9rem; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; display: -webkit-box; min-height: 2.7em; }
        .featured-price, .product-price { font-weight: bold; margin-top: 8px; color: var(--primary); }
        .featured-title { font-size: 1rem; font-weight: bold; white-space: nowrap; text-overflow: ellipsis; }
        .featured-price { font-size: 0.9rem; color: var(--primary-light); }
        .btn-add-to-cart { background-color: var(--primary); color: white; border: none; padding: 8px; border-radius: 5px; cursor: pointer; margin-top: 10px; font-weight: bold; font-size: 0.8rem; width: 100%; }
        .filter-controls { display: flex; flex-wrap: wrap; gap: 10px; padding: 15px; background-color: var(--header-color); border-top: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color);}
        .filter-controls input, .filter-controls select { flex: 1 1 150px; padding: 10px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-color); font-size: 0.9rem; }
        .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; padding: 15px; }
        .favorite-icon { position: absolute; top: 10px; right: 10px; font-size: 1.3rem; color: #FFF; background-color: rgba(0,0,0,0.4); border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 2; }
        .favorite-icon.is-favorite { color: var(--accent-red); }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; display: flex; justify-content: space-around; background-color: var(--header-color); padding-top: 10px; padding-bottom:10px; z-index: 100; border-top: 1px solid var(--border-color); }
        .nav-item { display: flex; flex-direction: column; align-items: center; font-size: 0.75rem; cursor: pointer; color: var(--text-secondary); }
        .nav-item.active { color: var(--primary); }
        .nav-item i { font-size: 1.2rem; margin-bottom: 3px; }
        .auth-modal, .cart-modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; }
        .auth-modal { background-color: var(--bg-color); overflow-y: auto; padding: 15px; }
        .cart-modal-overlay { background-color: rgba(0,0,0,0.7); align-items: flex-end; justify-content: center; }
        .cart-modal { background-color: var(--bg-color); width: 100%; max-height: 90vh; border-radius: 15px 15px 0 0; display: flex; flex-direction: column; animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .cart-header { padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); }
        .cart-header h2 { font-size: 1.2rem; }
        .close-btn { font-size: 1.5rem; cursor: pointer; color: var(--text-secondary); }
        .cart-items-container { overflow-y: auto; padding: 15px; flex-grow: 1; }
        .cart-item { display: flex; gap: 15px; align-items: center; margin-bottom: 15px; }
        .cart-item img { width: 70px; height: 70px; object-fit: cover; border-radius: 8px; }
        .cart-item-info { flex-grow: 1; }
        .cart-item-title { font-weight: bold; font-size: 0.9rem; }
        .cart-item-price { color: var(--primary); font-size: 0.9rem; margin: 5px 0; }
        .quantity-controls { display: flex; align-items: center; gap: 10px; }
        .quantity-controls button { background-color: var(--card-color); border: 1px solid var(--border-color); width: 25px; height: 25px; border-radius: 50%; cursor: pointer; font-weight: bold; }
        .cart-footer { padding: 15px; border-top: 1px solid var(--border-color); }
        .cart-total { display: flex; justify-content: space-between; font-weight: bold; font-size: 1.1rem; margin-bottom: 15px; }
        .btn-checkout { background-color: var(--primary); color: white; width: 100%; padding: 14px; font-size: 1rem; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; }
        .auth-container { width: 100%; max-width: 420px; margin: 0 auto; }
        .auth-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .auth-header .logo { font-size: 1.5rem; }
        .auth-header .close-btn { font-size: 1.8rem; cursor: pointer; color: var(--text-secondary); }
        .auth-tabs { display: flex; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; margin-bottom: 2rem; }
        .tab-link { flex: 1; padding: 12px; text-align: center; background-color: transparent; color: var(--text-secondary); cursor: pointer; border: none; font-size: 1rem; }
        .tab-link.active { background-color: var(--primary); color: #FFFFFF; font-weight: bold; }
        .auth-view { display: none; } .auth-view.active { display: block; } .auth-title { font-size: 1.5rem; font-weight: bold; margin-bottom: 1.5rem; }
        .form-group { margin-bottom: 1.2rem; }
        .form-group label { display: block; margin-bottom: 8px; font-size: 0.9rem; color: var(--text-secondary); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; background-color: var(--card-color); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-color); font-size: 1rem; }
        .form-group input[type="file"] { padding: 5px; }
        .form-group textarea { resize: vertical; min-height: 100px; }
        .form-group .phone-group { display: flex; }
        .form-group .phone-prefix { padding: 12px; border: 1px solid var(--border-color); border-right: none; border-radius: 8px 0 0 8px; background-color: var(--card-color); }
        .btn-primary { background-color: var(--primary); color: #FFFFFF; width: 100%; padding: 14px; font-size: 1rem; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; margin-top: 1rem; }
        .btn-primary:disabled, .btn-secondary:disabled { background-color: var(--text-secondary); cursor: not-allowed; opacity: 0.7; }
        .btn-secondary { background-color: transparent; color: var(--primary); border: 1px solid var(--primary); width: 100%; padding: 14px; font-size: 1rem; font-weight: bold; border-radius: 8px; cursor: pointer; }
        #loader { display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000; background-color: rgba(0, 0, 0, 0.7); justify-content: center; align-items: center; } .spinner { width: 50px; height: 50px; border: 5px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: var(--primary); animation: spin 1s linear infinite; } @keyframes spin { to { transform: rotate(360deg); } }
        .vendor-panel-container{padding:15px}
        .list-item{background-color:var(--card-color);padding:15px;border-radius:8px;margin-bottom:10px;display:flex;align-items:center;gap:15px}
        .list-item img{width:60px;height:60px;border-radius:4px;object-fit:cover}
        .list-item-info{flex:1}
        .list-item-actions{display:flex;gap:10px}
        .list-item-actions button, .list-item .btn-review {background:transparent;border:none;color:var(--text-color);font-size:1.2rem;cursor:pointer}
        .list-item-actions .btn-delete{color:var(--accent-red)}
        .list-item .btn-review { font-size: 0.8rem; border: 1px solid var(--primary); color: var(--primary); padding: 5px 10px; border-radius: 20px; white-space: nowrap;}
        .list-item .btn-review:disabled { border-color: var(--text-secondary); color: var(--text-secondary); cursor: not-allowed;}
        .review-card{background-color:var(--card-color);padding:15px;border-radius:8px;margin-bottom:10px; border-left: 3px solid var(--primary);}
        .review-stars{color:var(--primary-light)}
        .contact-modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:3000}
        .contact-modal{background:var(--card-color);padding:25px;border-radius:12px;width:90%;max-width:350px;text-align:center; animation: slideUp 0.3s ease-out; }
        .contact-modal h3{margin-bottom:20px}
        .contact-buttons{display:flex;flex-direction:column;gap:15px}
        .btn-contact{padding:12px;border-radius:8px;text-decoration:none;font-weight:bold;display:flex;align-items:center;justify-content:center;gap:10px;color:white;border:none;font-size:1rem;}
        .btn-whatsapp{background-color:var(--whatsapp-green);}
        .btn-call{background-color:var(--primary);}
        .rating-stars { display: flex; justify-content: center; margin-bottom: 1rem; direction: rtl; }
        .rating-stars input[type="radio"] { display: none; }
        .rating-stars label { font-size: 2rem; color: #444; cursor: pointer; transition: color 0.2s; }
        .rating-stars input[type="radio"]:checked ~ label, .rating-stars label:hover, .rating-stars label:hover ~ label { color: var(--primary-light); }
        .forgot-password a, .terms-group a, .auth-footer-link a { color: var(--primary); text-decoration: none; }
        .auth-footer-link { text-align: center; margin-top: 1.5rem; }
        .info-message { text-align: center; color: var(--text-secondary); padding: 40px 15px; }
        .account-actions { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
        .status-badge { padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; color: #FFF; }
        .status-badge.pending { background-color: var(--pending-orange); }
        .status-badge.active { background-color: var(--success-green); }

        /* ESTILOS PARA OS PAINÉIS DE REGISTO */
        .register-panel {
            display: none;
        }
        .register-panel.active {
            display: block;
        }
        .registration-nav-buttons {
            display: flex;
            gap: 10px;
            margin-top: 1rem;
        }

        /* NOVO: Estilos para o ícone de mostrar/ocultar senha */
        .form-group.password-group {
            position: relative;
        }
        .toggle-password {
            position: absolute;
            bottom: 14px;
            right: 15px;
            cursor: pointer;
            color: var(--text-secondary);
        }

        @media (min-width: 768px) {
            body { padding-bottom: 0; }
            main, .bottom-nav { max-width: 1200px; margin: 0 auto; }
            .bottom-nav { position: static; border-radius: 10px; margin-top: 20px; }
            .products-grid { grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); }
            .featured-card { flex: 0 0 350px; }
            .account-actions { flex-direction: row; }
        }
        @media (min-width: 1024px) {
            .filter-controls { flex-wrap: nowrap; }
        }
    </style>
</head>
<body data-theme="dark">
    <div id="loader"><div class="spinner"></div></div>

    <div id="app-container">
        <header>
            <div class="logo"><i class="fas fa-shopping-bag"></i> PAMBALA</div>
            <div class="header-icons">
                <i class="fas fa-moon" id="theme-toggle-btn"></i>
                <div class="cart-icon-wrapper">
                    <i class="fas fa-shopping-cart" id="cart-icon"></i>
                    <span class="cart-badge" id="cart-count-badge" style="display: none;">0</span>
                </div>
                <div id="user-icon-container">
                    <i class="far fa-user" id="user-icon"></i>
                </div>
            </div>
        </header>

        <main>
            <div id="buyer-panels-container">
                <div id="buyer-panel">
                    <div class="featured-carousel"><div class="section-title" style="padding: 15px 0 10px 0;">Destaques</div><div class="carousel-container" id="featured-container"></div></div>
                    <div class="category-icons-section"><div class="category-icons-container" id="category-icons-container"></div></div>
                    <div class="filter-controls">
                        <input type="search" id="search-input" placeholder="O que procuras?">
                        <select id="category-filter"><option value="">Todas as Categorias</option></select>
                        <select id="location-filter"><option value="">Todas as Localizações</option></select>
                    </div>
                    <div class="section-header" style="padding-top: 0px;"><div class="section-title" style="padding-top: 0px;">Todos os Produtos</div><button id="switch-to-vendor-btn" class="btn-vendor-switch">Modo Vendedor</button></div>
                    <div class="products-grid" id="products-container"></div>
                </div>
                <div id="purchases-panel" style="display: none;"><div class="section-title">Minhas Compras</div><div id="purchases-container" class="vendor-panel-container"></div></div>
                <div id="favorites-panel" style="display: none;"><div class="section-title">Meus Favoritos</div><div class="products-grid" id="favorites-container"></div></div>
                <div id="account-panel" class="vendor-panel-container" style="display: none;">
                    <h2 class="section-title" style="padding: 0 0 15px 0;">Minha Conta</h2>
                    <div class="list-item">
                        <div class="list-item-info">
                            <strong>Meu Saldo</strong>
                            <div id="user-balance" style="color: var(--primary); font-size: 1.2rem; font-weight: bold;">AOA 0.00</div>
                        </div>
                    </div>
                    <div class="account-actions">
                         <button id="top-up-btn" class="btn-primary" style="margin-top:0;">Recarregar</button>
                         <button id="withdraw-btn" class="btn-secondary" style="margin-top:0;">Levantar</button>
                    </div>
                     <div class="list-item" style="margin-top:20px;">
                        <div class="list-item-info">
                            <strong>Meu Código de Padrinho</strong>
                            <p style="font-size: 0.8rem; color: var(--text-secondary);">Partilhe e ganhe quando um afilhado comprar um selo!</p>
                            <strong id="user-referral-code" style="font-size: 1.1rem; letter-spacing: 2px; margin-top: 5px;">-</strong>
                        </div>
                        <button id="copy-code-btn" class="btn-review" style="font-size: 1rem;"><i class="fas fa-copy"></i></button>
                    </div>

                    <div id="verification-section" style="margin-top: 10px; padding: 15px; background-color: var(--card-color); border-radius: 8px;">
                        <h3 id="verification-title">Verificação de Conta</h3>
                        <p style="font-size: 0.9rem; color: var(--text-secondary); margin: 10px 0;" id="verification-status-text">Aumente a confiança na comunidade.</p>
                        <div id="verification-actions" class="account-actions">
                        </div>
                    </div>

                     <div class="list-item" style="margin-top:20px; cursor:pointer;" id="logout-btn">
                        <div class="list-item-info"><strong style="color: var(--accent-red);">Terminar Sessão</strong></div>
                        <i class="fas fa-sign-out-alt" style="color: var(--accent-red);"></i>
                    </div>
                </div>
            </div>

            <div id="vendor-panels-container" style="display: none;">
                <div id="vendor-home-panel" class="vendor-panel-container"><h2 class="section-title" style="padding: 0 0 15px 0;">Meus Anúncios</h2><div id="my-products-list"></div></div>
                <div id="vendor-add-product-panel" class="vendor-panel-container" style="display: none;">
                    <h2 class="section-title" id="add-edit-form-title">Adicionar Novo Produto</h2>
                    <form id="add-product-form"><input type="hidden" id="product-id-input"><div class="form-group"><label for="product-name">Nome</label><input type="text" id="product-name" required></div><div class="form-group"><label for="product-description">Descrição</label><textarea id="product-description" required></textarea></div><div class="form-group"><label for="product-price">Preço (AOA)</label><input type="number" id="product-price" required></div><div class="form-group"><label for="product-category">Categoria</label><select id="product-category" required></select></div><div class="form-group"><label for="product-location">Localização</label><select id="product-location" required></select></div><div class="form-group"><label for="product-image-url">URL da Imagem</label><input type="url" id="product-image-url" placeholder="https://exemplo.com/imagem.jpg" required></div><div class="form-group" style="flex-direction: row; align-items: center; gap: 10px; display: flex;"><input type="checkbox" id="product-is-featured" style="width: auto;"><label for="product-is-featured" style="margin-bottom: 0;">Destaque</label></div><button type="submit" class="btn-primary" id="add-edit-form-button">Publicar</button></form>
                </div>
                <div id="vendor-messages-panel" style="display: none; padding: 0;"></div>
                <div id="vendor-profile-panel" class="vendor-panel-container" style="display: none;"><h2 class="section-title" style="padding: 0 0 15px 0;">Meu Perfil</h2><h3 style="font-size: 1rem; color: var(--text-secondary); margin-bottom: 15px;">Avaliações Recebidas</h3><div id="my-reviews-list"></div></div>
            </div>
        </main>

        <div id="buyer-bottom-nav" class="bottom-nav">
            <div class="nav-item active" data-panel="buyer-panel"><i class="fas fa-home"></i><div>Início</div></div>
            <div class="nav-item" data-panel="purchases-panel"><i class="fas fa-receipt"></i><div>Compras</div></div>
            <div class="nav-item" data-panel="favorites-panel"><i class="far fa-heart"></i><div>Favoritos</div></div>
            <div class="nav-item" data-panel="account-panel" id="buyer-account-nav"><i class="far fa-user"></i><div>Conta</div></div>
        </div>
        <div id="vendor-bottom-nav" class="bottom-nav" style="display: none;">
            <div class="nav-item active" data-panel="vendor-home-panel"><i class="fas fa-store"></i><div>Início</div></div>
            <div class="nav-item" data-panel="vendor-add-product-panel"><i class="fas fa-plus-circle"></i><div>Adicionar</div></div>
            <div class="nav-item" data-panel="vendor-messages-panel"><i class="fas fa-comments"></i><div>Mensagens</div></div>
            <div class="nav-item" data-panel="vendor-profile-panel"><i class="fas fa-user-cog"></i><div>Perfil</div></div>
        </div>
    </div>

    <div id="cart-modal-overlay" class="cart-modal-overlay">
        <div class="cart-modal">
            <div class="cart-header">
                <h2>Meu Carrinho</h2>
                <div class="close-btn" id="close-cart-btn">&times;</div>
            </div>
            <div class="cart-items-container" id="cart-items-container"></div>
            <div class="cart-footer">
                <div class="cart-total">
                    <span>Total</span>
                    <span id="cart-total">AOA 0</span>
                </div>
                <button class="btn-checkout" id="checkout-btn">Finalizar Compra</button>
            </div>
        </div>
    </div>

    <div id="auth-modal" class="auth-modal">
        <div class="auth-container">
            <div class="auth-header">
                <div class="logo">PAMBALA</div>
                <div class="close-btn" id="close-auth-btn">&times;</div>
            </div>
            <div class="auth-tabs" id="main-auth-tabs">
                <button class="tab-link main-tab active" data-tab="login-view">Entrar</button>
                <button class="tab-link main-tab" data-tab="register-view">Cadastrar</button>
            </div>
            <div id="login-view" class="auth-view active">
                <h2 class="auth-title">Bem-vindo</h2>
                <form id="login-form">
                    <div class="form-group">
                        <label for="login-email">E-mail</label>
                        <input type="email" id="login-email" required>
                    </div>
                    <div class="form-group password-group">
                        <label for="login-password">Senha</label>
                        <input type="password" id="login-password" required>
                        <i class="fas fa-eye toggle-password"></i>
                    </div>
                    <div class="forgot-password"><a href="#" id="forgot-password-link">Esqueceu a senha?</a></div>
                    <button type="submit" class="btn-primary">Entrar</button>
                </form>
            </div>

            <div id="register-view" class="auth-view">
                <form id="register-form">
                    <div class="auth-tabs">
                        <button type="button" class="tab-link account-type-btn active" data-type="buyer">Comprador</button>
                        <button type="button" class="tab-link account-type-btn" data-type="vendor">Vendedor</button>
                        <input type="hidden" id="register-account-type" value="buyer">
                    </div>

                    <div id="register-panel-1" class="register-panel active">
                        <h3 class="auth-title" style="font-size: 1.2rem; margin-top: 1.5rem;">Passo 1: Seus Dados</h3>
                        <div class="form-group"><label for="register-first-name">Primeiro nome</label><input type="text" id="register-first-name" required></div>
                        <div class="form-group"><label for="register-middle-name">Nome do meio (Opcional)</label><input type="text" id="register-middle-name"></div>
                        <div class="form-group"><label for="register-last-name">Último nome</label><input type="text" id="register-last-name" required></div>
                        <div class="form-group"><label for="register-dob">Data de Nascimento</label><input type="date" id="register-dob" required></div>
                        <div class="form-group"><label for="register-email">E-mail</label><input type="email" id="register-email" required></div>

                        <div class="form-group password-group">
                            <label for="register-password">Senha</label>
                            <input type="password" id="register-password" required>
                            <i class="fas fa-eye toggle-password"></i>
                        </div>
                        <div class="form-group password-group">
                            <label for="register-confirm">Confirmar Senha</label>
                            <input type="password" id="register-confirm" required>
                             <i class="fas fa-eye toggle-password"></i>
                        </div>

                        <button type="button" id="btn-next-step" class="btn-primary">Continuar</button>
                    </div>

                    <div id="register-panel-2" class="register-panel">
                        <h3 class="auth-title" style="font-size: 1.2rem; margin-top: 1.5rem;">Passo 2: Localização</h3>
                        <div class="form-group">
                            <label for="register-country">País</label>
                            <select id="register-country" required>
                                <option value="" disabled selected>Selecione o seu país</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="register-phone">Telefone</label>
                            <div class="phone-group">
                                <span class="phone-prefix" id="phone-prefix-display">+244</span> 
                                <input type="tel" id="register-phone" placeholder="Seu número" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="register-province">Província</label>
                            <select id="register-province" required disabled>
                                <option value="">Primeiro, selecione um país</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="register-municipality">Município</label>
                            <select id="register-municipality" required disabled>
                                <option value="">Primeiro, selecione uma província</option>
                            </select>
                        </div>
                        <div class="form-group"><label for="register-id">Nº do BI</label><input type="text" id="register-id" required></div>
                        <div class="form-group"><label for="register-referral-code">Cód. de Padrinho (Opcional)</label><input type="text" id="register-referral-code"></div>
                        <div class="terms-group"><input type="checkbox" id="register-terms" required><label for="register-terms">Concordo com os <a href="#">Termos</a> e <a href="#">Privacidade</a></label></div>

                        <div class="registration-nav-buttons">
                            <button type="button" id="btn-prev-step" class="btn-secondary">Voltar</button>
                            <button type="submit" class="btn-primary" style="margin-top:0;">Criar Conta</button>
                        </div>
                    </div>
                </form>
            </div>
            <div id="password-recovery-view" class="auth-view">
                <h2 class="auth-title">Recuperar Senha</h2>
                <p style="color:var(--text-secondary);margin-bottom:1.5rem">Insira o seu e-mail para receber um link de recuperação.</p>
                <form id="recovery-form">
                    <div class="form-group">
                        <label for="recovery-email">E-mail</label>
                        <input type="email" id="recovery-email" required>
                    </div>
                    <button type="submit" class="btn-primary">Enviar Link</button>
                </form>
                <div class="auth-footer-link"><a href="#" id="back-to-login-link">Voltar para o Login</a></div>
            </div>
            <div id="update-password-view" class="auth-view">
                <h2 class="auth-title">Definir Nova Senha</h2>
                <p style="color:var(--text-secondary);margin-bottom:1.5rem">Crie uma nova senha para a sua conta. Deve ter no mínimo 6 caracteres.</p>
                <form id="update-password-form">
                    <div class="form-group">
                        <label for="update-password">Nova Senha</label>
                        <input type="password" id="update-password" required minlength="6">
                    </div>
                    <button type="submit" class="btn-primary">Atualizar Senha</button>
                </form>
            </div>
        </div>
    </div>

    <div id="contact-modal-overlay" class="contact-modal-overlay"><div class="contact-modal"><h3 id="contact-modal-title">Contactar Vendedor</h3><div class="contact-buttons"><a href="#" id="whatsapp-btn" class="btn-contact btn-whatsapp" target="_blank"><i class="fab fa-whatsapp"></i> WhatsApp</a><a href="#" id="call-btn" class="btn-contact btn-call"><i class="fas fa-phone"></i> Ligar</a></div><button id="close-contact-modal-btn" style="margin-top:20px;background:none;border:none;color:var(--text-secondary)">Fechar</button></div></div>
    <div id="review-modal-overlay" class="contact-modal-overlay"><div class="contact-modal"><h3>Avaliar Produto</h3><form id="review-form"><input type="hidden" id="review-order-id" name="order-id"><input type="hidden" id="review-product-id" name="product-id"><input type="hidden" id="review-seller-id" name="seller-id"><div class="form-group"><div class="rating-stars"><input type="radio" id="star5" name="rating" value="5" required><label for="star5">★</label><input type="radio" id="star4" name="rating" value="4"><label for="star4">★</label><input type="radio" id="star3" name="rating" value="3"><label for="star3">★</label><input type="radio" id="star2" name="rating" value="2"><label for="star2">★</label><input type="radio" id="star1" name="rating" value="1"><label for="star1">★</label></div></div><div class="form-group"><label for="review-comment">Comentário</label><textarea id="review-comment" name="comment"></textarea></div><button type="submit" class="btn-primary">Enviar Avaliação</button></form><button id="close-review-modal-btn" style="margin-top:20px;background:none;border:none;color:var(--text-secondary)">Fechar</button></div></div>
    <div id="top-up-modal-overlay" class="contact-modal-overlay"><div class="contact-modal"><h3>Recarregar Saldo</h3><p style="font-size:0.9rem; color: var(--text-secondary); margin-bottom: 15px;">Simulação de recarga via Unitel Money.</p><form id="top-up-form"><div class="form-group"><label for="top-up-amount">Valor (AOA)</label><input type="number" id="top-up-amount" required min="100" placeholder="Ex: 5000"></div><div class="form-group"><label for="top-up-phone">Nº de Telefone (Unitel Money)</label><input type="tel" id="top-up-phone" required placeholder="9XX XXX XXX"></div><button type="submit" class="btn-primary">Pagar</button></form><button id="close-top-up-modal-btn" style="margin-top:20px;background:none;border:none;color:var(--text-secondary)">Cancelar</button></div></div>
    <div id="withdraw-modal-overlay" class="contact-modal-overlay"><div class="contact-modal"><h3>Levantar Saldo</h3><p style="font-size:0.9rem; color: var(--text-secondary); margin-bottom: 15px;">O pedido será processado pela nossa equipa.</p><p style="font-size:1rem; margin-bottom: 15px;">Saldo Disponível: <strong id="withdraw-available-balance" style="color: var(--primary);">AOA 0.00</strong></p><form id="withdraw-form"><div class="form-group"><label for="withdraw-amount">Valor a Levantar (AOA)</label><input type="number" id="withdraw-amount" required min="1000"></div><div class="form-group"><label for="withdraw-details">Detalhes de Pagamento</label><input type="text" id="withdraw-details" required placeholder="Nº de conta ou telemóvel"></div><button type="submit" class="btn-primary">Solicitar Levantamento</button></form><button id="close-withdraw-modal-btn" style="margin-top:20px;background:none;border:none;color:var(--text-secondary)">Cancelar</button></div></div>
    <div id="verification-modal-overlay" class="contact-modal-overlay">
        <div class="contact-modal" style="max-width: 450px; text-align: left;">
            <h3 id="verification-modal-title">Candidatura de Verificação</h3>
            <p style="font-size:0.9rem; color: var(--text-secondary); margin-bottom: 20px;">Envie os seus documentos para análise.</p>
            <form id="verification-form">
                <input type="hidden" id="verification-type-input">
                <div class="form-group">
                    <label for="verification-name">Nome Completo (como no BI)</label>
                    <input type="text" id="verification-name" required>
                </div>
                <div class="form-group">
                    <label for="verification-bi-front">BI (Frente)</label>
                    <input type="file" id="verification-bi-front" accept="image/*" required>
                </div>
                <div class="form-group">
                    <label for="verification-bi-back">BI (Verso)</label>
                    <input type="file" id="verification-bi-back" accept="image/*" required>
                </div>
                 <div class="form-group">
                    <label for="verification-avatar">Foto de Perfil</label>
                    <input type="file" id="verification-avatar" accept="image/*" required>
                </div>
                <button type="submit" class="btn-primary">Submeter Candidatura</button>
            </form>
            <button id="close-verification-modal-btn" style="margin-top:20px;background:none;border:none;color:var(--text-secondary); width: 100%; text-align: center;">Cancelar</button>
        </div>
    </div>

    <script>
        const supabaseUrl = 'https://hztwtjgxhfrognqyjxaq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh6dHd0amd4aGZyb2ducXlqeGFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwMjcxNzMsImV4cCI6MjA3MDYwMzE3M30.PBqfdKkkFSXicHQBjfZQEDt0C33Y88nLF1tpovurNXk';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        const imageCompression = window.imageCompression;

        /**
         * Objeto para armazenar os dados de localização de cada país.
         * Inclui o prefixo telefónico e uma lista de províncias com os seus municípios.
         */
        const locationData = {
            'Angola': {
                prefix: '+244',
                provincias: [
                    { nome: 'Bengo', municipios: ['Ambriz', 'Bula Atumba', 'Dande', 'Dembos', 'Nambuangongo', 'Pango Aluquém'] },
                    { nome: 'Benguela', municipios: ['Balombo', 'Baía Farta', 'Benguela', 'Bocoio', 'Caimbambo', 'Catumbela', 'Chongorói', 'Cubal', 'Ganda', 'Lobito'] },
                    { nome: 'Bié', municipios: ['Andulo', 'Camacupa', 'Catabola', 'Chinguar', 'Chitembo', 'Cuemba', 'Cunhinga', 'Kuito', 'Nharea'] },
                    { nome: 'Cabinda', municipios: ['Belize', 'Buco-Zau', 'Cabinda', 'Cacongo'] },
                    { nome: 'Cuando Cubango', municipios: ['Calai', 'Cuangar', 'Cuchi', 'Cuito Cuanavale', 'Dirico', 'Mavinga', 'Menongue', 'Nancova', 'Rivungo'] },
                    { nome: 'Cuanza Norte', municipios: ['Ambaca', 'Banga', 'Bolongongo', 'Cambambe', 'Cazengo', 'Golungo Alto', 'Gonguembo', 'Lucala', 'Quiculungo', 'Samba Caju'] },
                    { nome: 'Cuanza Sul', municipios: ['Amboim', 'Cassongue', 'Cela', 'Conda', 'Ebo', 'Libolo', 'Mussende', 'Porto Amboim', 'Quibala', 'Quilenda', 'Seles', 'Sumbe'] },
                    { nome: 'Cunene', municipios: ['Cahama', 'Cuanhama', 'Curoca', 'Cuvelai', 'Namacunde', 'Ombadja'] },
                    { nome: 'Huambo', municipios: ['Bailundo', 'Caála', 'Catchiungo', 'Ekunha', 'Huambo', 'Londuimbali', 'Longonjo', 'Mungo', 'Tchicala-Tcholoanga', 'Tchindjenje', 'Ucuma'] },
                    { nome: 'Huíla', municipios: ['Caconda', 'Cacula', 'Caluquembe', 'Chiange', 'Chibia', 'Chicomba', 'Chipindo', 'Cuvango', 'Humpata', 'Jamba', 'Lubango', 'Matala', 'Quilengues', 'Quipungo'] },
                    { nome: 'Luanda', municipios: ['Belas', 'Cacuaco', 'Cazenga', 'Ícolo e Bengo', 'Luanda', 'Quiçama', 'Talatona', 'Viana'] },
                    { nome: 'Lunda Norte', municipios: ['Cambulo', 'Capenda-Camulemba', 'Caungula', 'Chitato', 'Cuango', 'Cuílo', 'Lóvua', 'Lubalo', 'Lucapa', 'Xá-Muteba'] },
                    { nome: 'Lunda Sul', municipios: ['Cacolo', 'Dala', 'Muconda', 'Saurimo'] },
                    { nome: 'Malanje', municipios: ['Cacuso', 'Calandula', 'Cambundi-Catembo', 'Cangandala', 'Caombo', 'Cuaba Nzoji', 'Cunda-Dia-Baze', 'Luquembo', 'Malanje', 'Marimba', 'Massango', 'Mucari', 'Quela', 'Quirima'] },
                    { nome: 'Moxico', municipios: ['Alto Zambeze', 'Bundas', 'Camanongue', 'Léua', 'Luacano', 'Luau', 'Luchazes', 'Luena', 'Moxico'] },
                    { nome: 'Namibe', municipios: ['Bibala', 'Camucuio', 'Moçâmedes', 'Tômbua', 'Virei'] },
                    { nome: 'Uíge', municipios: ['Alto Cauale', 'Ambuíla', 'Bembe', 'Buengas', 'Bungo', 'Damba', 'Maquela do Zombo', 'Milunga', 'Mucaba', 'Negage', 'Puri', 'Quimbele', 'Quitexe', 'Sanza Pombo', 'Songo', 'Uíge'] },
                    { nome: 'Zaire', municipios: ['Cuimba', 'Mabanza Congo', 'Nezeto', 'Nóqui', 'Soio', 'Tomboco'] },
                ]
            },
            'Moçambique': {
                prefix: '+258',
                provincias: [
                    { nome: 'Cabo Delgado', municipios: ['Ancuabe', 'Balama', 'Chiúre', 'Ibo', 'Macomia', 'Mecúfi', 'Meluco', 'Metuge', 'Mocímboa da Praia', 'Montepuez', 'Mueda', 'Muidumbe', 'Namuno', 'Nangade', 'Palma', 'Pemba'] },
                    { nome: 'Gaza', municipios: ['Bilene', 'Chibuto', 'Chicualacuala', 'Chigubo', 'Chókwè', 'Chongoene', 'Guijá', 'Limpopo', 'Mabalane', 'Manjacaze', 'Mapai', 'Massangena', 'Massingir', 'Xai-Xai'] },
                    { nome: 'Inhambane', municipios: ['Funhalouro', 'Govuro', 'Homoíne', 'Inharrime', 'Inhassoro', 'Jangamo', 'Mabote', 'Massinga', 'Maxixe', 'Morrumbene', 'Panda', 'Vilanculos', 'Zavala'] },
                    { nome: 'Manica', municipios: ['Bárue', 'Chimoio', 'Gondola', 'Guro', 'Macate', 'Machaze', 'Macossa', 'Manica', 'Mossurize', 'Sussundenga', 'Tambara', 'Vanduzi'] },
                    { nome: 'Maputo Cidade', municipios: ['Maputo'] },
                    { nome: 'Maputo Província', municipios: ['Boane', 'Magude', 'Manhiça', 'Marracuene', 'Matola', 'Matutuíne', 'Moamba', 'Namaacha'] },
                    { nome: 'Nampula', municipios: ['Angoche', 'Eráti', 'Ilha de Moçambique', 'Lalaua', 'Larde', 'Lunga', 'Malema', 'Meconta', 'Mecubúri', 'Memba', 'Mogincual', 'Mogovolas', 'Moma', 'Monapo', 'Mossuril', 'Muecate', 'Murrupula', 'Nacala-a-Velha', 'Nacala Porto', 'Nacarôa', 'Nampula', 'Rapale', 'Ribauè'] },
                    { nome: 'Niassa', municipios: ['Chimbonila', 'Cuamba', 'Lago', 'Lichinga', 'Majune', 'Mandimba', 'Marrupa', 'Maúa', 'Mavago', 'Mecanhelas', 'Mecula', 'Metarica', 'Muembe', 'N\'gauma', 'Nipepe', 'Sanga'] },
                    { nome: 'Sofala', municipios: ['Beira', 'Búzi', 'Caia', 'Chemba', 'Cheringoma', 'Chibabava', 'Dondo', 'Gorongosa', 'Machanga', 'Maringué', 'Marromeu', 'Muanza', 'Nhamatanda'] },
                    { nome: 'Tete', municipios: ['Angónia', 'Cahora-Bassa', 'Changara', 'Chifunde', 'Chiuta', 'Dôa', 'Macanga', 'Magoé', 'Marara', 'Marávia', 'Moatize', 'Mutarara', 'Tete', 'Tsangano', 'Zumbo'] },
                    { nome: 'Zambézia', municipios: ['Alto Molócuè', 'Chinde', 'Derre', 'Gilé', 'Gurué', 'Ile', 'Inhassunge', 'Luabo', 'Lugela', 'Maganja da Costa', 'Milange', 'Mocuba', 'Mocubela', 'Mopeia', 'Morrumbala', 'Mulumbo', 'Namacurra', 'Namarroi', 'Nicoadala', 'Pebane', 'Quelimane'] },
                ]
            }
        };

        const state = {
            currentUser: null,
            userProfile: null,
            userFavorites: new Set(),
            cart: [],
            currentFilters: { name: '', categoryId: '', locationId: '' }
        };
        let searchTimeout;

        const DOM = {
            loader: document.getElementById('loader'),
            userIconContainer: document.getElementById('user-icon-container'),
            appContainer: document.getElementById('app-container'),
            authModal: document.getElementById('auth-modal'),
            closeAuthBtn: document.getElementById('close-auth-btn'),
            themeToggleBtn: document.getElementById('theme-toggle-btn'),
            cartIcon: document.getElementById('cart-icon'),
            cartCountBadge: document.getElementById('cart-count-badge'),
            cartModalOverlay: document.getElementById('cart-modal-overlay'),
            closeCartBtn: document.getElementById('close-cart-btn'),
            cartItemsContainer: document.getElementById('cart-items-container'),
            cartTotal: document.getElementById('cart-total'),
            checkoutBtn: document.getElementById('checkout-btn'),
            buyerPanelsContainer: document.getElementById('buyer-panels-container'),
            vendorPanelsContainer: document.getElementById('vendor-panels-container'),
            productsContainer: document.getElementById('products-container'),
            favoritesContainer: document.getElementById('favorites-container'),
            purchasesContainer: document.getElementById('purchases-container'),
            loginForm: document.getElementById('login-form'),
            registerForm: document.getElementById('register-form'),
            recoveryForm: document.getElementById('recovery-form'),
            updatePasswordForm: document.getElementById('update-password-form'),
            switchToVendorBtn: document.getElementById('switch-to-vendor-btn'),
            featuredContainer: document.getElementById('featured-container'),
            searchInput: document.getElementById('search-input'),
            categoryFilter: document.getElementById('category-filter'),
            locationFilter: document.getElementById('location-filter'),
            buyerBottomNav: document.getElementById('buyer-bottom-nav'),
            vendorBottomNav: document.getElementById('vendor-bottom-nav'),
            myProductsList: document.getElementById('my-products-list'),
            myReviewsList: document.getElementById('my-reviews-list'),
            addProductForm: document.getElementById('add-product-form'),
            addEditFormTitle: document.getElementById('add-edit-form-title'),
            addEditFormButton: document.getElementById('add-edit-form-button'),
            productIdInput: document.getElementById('product-id-input'),
            contactModalOverlay: document.getElementById('contact-modal-overlay'),
            contactModalTitle: document.getElementById('contact-modal-title'),
            whatsappBtn: document.getElementById('whatsapp-btn'),
            callBtn: document.getElementById('call-btn'),
            closeContactModalBtn: document.getElementById('close-contact-modal-btn'),
            reviewModalOverlay: document.getElementById('review-modal-overlay'),
            reviewForm: document.getElementById('review-form'),
            closeReviewModalBtn: document.getElementById('close-review-modal-btn'),
            logoutBtn: document.getElementById('logout-btn'),
            forgotPasswordLink: document.getElementById('forgot-password-link'),
            backToLoginLink: document.getElementById('back-to-login-link'),
            mainAuthTabs: document.getElementById('main-auth-tabs'),
            accountTypeBtns: document.querySelectorAll('.account-type-btn'),
            authTabBtns: document.querySelectorAll('.main-tab'),
            categoryIconsContainer: document.getElementById('category-icons-container'),
            userBalance: document.getElementById('user-balance'),
            userReferralCode: document.getElementById('user-referral-code'),
            copyCodeBtn: document.getElementById('copy-code-btn'),
            topUpBtn: document.getElementById('top-up-btn'),
            withdrawBtn: document.getElementById('withdraw-btn'),
            topUpModalOverlay: document.getElementById('top-up-modal-overlay'),
            withdrawModalOverlay: document.getElementById('withdraw-modal-overlay'),
            closeTopUpModalBtn: document.getElementById('close-top-up-modal-btn'),
            closeWithdrawModalBtn: document.getElementById('close-withdraw-modal-btn'),
            topUpForm: document.getElementById('top-up-form'),
            withdrawForm: document.getElementById('withdraw-form'),
            withdrawAvailableBalance: document.getElementById('withdraw-available-balance'),
            verificationSection: document.getElementById('verification-section'),
            verificationTitle: document.getElementById('verification-title'),
            verificationStatusText: document.getElementById('verification-status-text'),
            verificationActions: document.getElementById('verification-actions'),
            verificationModalOverlay: document.getElementById('verification-modal-overlay'),
            verificationModalTitle: document.getElementById('verification-modal-title'),
            verificationForm: document.getElementById('verification-form'),
            verificationTypeInput: document.getElementById('verification-type-input'),
            closeVerificationModalBtn: document.getElementById('close-verification-modal-btn'),
            // Elementos do novo formulário de registo
            btnNextStep: document.getElementById('btn-next-step'),
            btnPrevStep: document.getElementById('btn-prev-step'),
            registerPanel1: document.getElementById('register-panel-1'),
            registerPanel2: document.getElementById('register-panel-2'),
        };

        function showLoader() { DOM.loader.style.display = 'flex'; }
        function hideLoader() { DOM.loader.style.display = 'none'; }
        function formatCurrency(amount) { return new Intl.NumberFormat('pt-AO', { style: 'currency', currency: 'AOA', minimumFractionDigits: 2 }).format(amount || 0); }

        async function compressImage(file) {
            if (!file) return null;
            console.log(`Original file size ${file.size / 1024 / 1024} MB`);
            const options = {
                maxSizeMB: 1,
                maxWidthOrHeight: 1024,
                useWebWorker: true,
            }
            try {
                const compressedFile = await imageCompression(file, options);
                console.log(`Compressed file size ${compressedFile.size / 1024 / 1024} MB`);
                return compressedFile;
            } catch (error) {
                console.error('Error compressing image:', error);
                return file;
            }
        }

        function setTheme(theme) { document.body.dataset.theme = theme; localStorage.setItem('pambala-theme', theme); DOM.themeToggleBtn.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon'; document.getElementById('theme-color-meta').setAttribute('content', theme === 'dark' ? '#121212' : '#F5F5F5'); }
        function toggleTheme() { setTheme(document.body.dataset.theme === 'dark' ? 'light' : 'dark'); }
        function loadTheme() { const savedTheme = localStorage.getItem('pambala-theme') || (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'); setTheme(savedTheme); }

        function switchAuthView(viewToShow) {
            document.querySelectorAll('.auth-view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
            const viewElement = document.getElementById(viewToShow);
            if (viewElement) viewElement.classList.add('active');
            const tabElement = document.querySelector(`.main-tab[data-tab="${viewToShow}"]`);
            if (tabElement) tabElement.classList.add('active');
            DOM.mainAuthTabs.style.display = (viewToShow === 'login-view' || viewToShow === 'register-view') ? 'flex' : 'none';
        }
        function openAuthModal(view = 'login-view') { DOM.authModal.style.display = 'block'; switchAuthView(view); }
        function closeAuthModal() { DOM.authModal.style.display = 'none'; }

        async function login(email, password) {
            showLoader();
            try {
                const { error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) throw error;
            } catch (error) {
                hideLoader();
                alert('Erro no login: ' + error.message);
            }
        }

        async function signOut() {
            showLoader();
            await supabase.auth.signOut();
            hideLoader();
        }

        async function handleRegister(e) {
            e.preventDefault();
            const form = DOM.registerForm;

            // Validações finais antes de submeter
            const angolanPhoneRegex = /^\d{9}$/; // Ajustado para aceitar 9 dígitos
            const phoneInput = form.querySelector('#register-phone').value.trim();
            if (!angolanPhoneRegex.test(phoneInput)) { 
                alert('Por favor, insira um número de telefone válido (9 dígitos).'); 
                return;
            }
            if (!form.querySelector('#register-terms').checked) { 
                alert('Deve concordar com os Termos e Privacidade.'); 
                return; 
            }

            showLoader();
            try {
                // Junta os nomes
                const firstName = form.querySelector('#register-first-name').value.trim();
                const middleName = form.querySelector('#register-middle-name').value.trim();
                const lastName = form.querySelector('#register-last-name').value.trim();
                const fullName = `${firstName} ${middleName} ${lastName}`.replace(/\s+/g, ' ').trim();

                const phonePrefix = document.getElementById('phone-prefix-display').textContent;
                const fullPhoneNumber = `${phonePrefix}${phoneInput}`;

                const { data: authData, error: authError } = await supabase.auth.signUp({
                    email: form.querySelector('#register-email').value,
                    password: form.querySelector('#register-password').value,
                });
                if (authError) throw authError;

                const profileData = {
                    id: authData.user.id,
                    full_name: fullName,
                    phone: fullPhoneNumber,
                    date_of_birth: form.querySelector('#register-dob').value,
                    id_number: form.querySelector('#register-id').value,
                    address: `${form.querySelector('#register-municipality').value}, ${form.querySelector('#register-province').value}, ${form.querySelector('#register-country').value}`,
                    account_type: form.querySelector('#register-account-type').value,
                    referral_code: 'PAM' + Math.random().toString(36).substring(2, 8).toUpperCase()
                };

                const referralCode = form.querySelector('#register-referral-code').value.trim();
                if (referralCode) {
                    const { data: referrer, error: referrerError } = await supabase.from('profiles').select('id').eq('referral_code', referralCode).single();
                    if (referrer && !referrerError) {
                        profileData.referred_by = referrer.id;
                    }
                }

                const { error: profileError } = await supabase.from('profiles').insert(profileData);
                if (profileError) throw profileError;

                alert('Registo concluído! Verifique o seu e-mail para confirmar a conta.');
                switchAuthView('login-view');
            } catch (error) {
                alert('Erro no registo: ' + error.message);
            } finally {
                hideLoader();
            }
        }

        async function handlePasswordRecovery(e) { e.preventDefault(); const email = DOM.recoveryForm.querySelector('#recovery-email').value; showLoader(); const { error } = await supabase.auth.resetPasswordForEmail(email, { redirectTo: window.location.origin }); hideLoader(); if (error) { alert("Erro ao enviar link: " + error.message); } else { alert("Link de recuperação enviado! Verifique o seu e-mail."); switchAuthView('login-view'); } }
        async function handleUpdatePassword(e) { e.preventDefault(); const newPassword = DOM.updatePasswordForm.querySelector('#update-password').value; if (newPassword.length < 6) { alert("A senha deve ter no mínimo 6 caracteres."); return; } showLoader(); const { error } = await supabase.auth.updateUser({ password: newPassword }); hideLoader(); if (error) { alert("Erro ao atualizar a senha: " + error.message); } else { alert("Senha atualizada com sucesso!"); await supabase.auth.signOut(); } }

        function saveCartToLocalStorage() { localStorage.setItem('pambala-cart', JSON.stringify(state.cart)); }
        function loadCartFromLocalStorage() { const savedCart = localStorage.getItem('pambala-cart'); if (savedCart) { state.cart = JSON.parse(savedCart); } renderCart(); }

        function addToCart(product) { const existingItem = state.cart.find(item => item.id === product.id); if (existingItem) { existingItem.quantity++; } else { state.cart.push({ ...product, quantity: 1 }); } saveCartToLocalStorage(); renderCart(); }
        function updateCartQuantity(productId, newQuantity) { const item = state.cart.find(item => item.id === productId); if (item) { if (newQuantity <= 0) { removeFromCart(productId); } else { item.quantity = newQuantity; saveCartToLocalStorage(); renderCart(); } } }
        function removeFromCart(productId) { state.cart = state.cart.filter(item => item.id !== productId); saveCartToLocalStorage(); renderCart(); }
        function clearCart() { state.cart = []; saveCartToLocalStorage(); renderCart(); }

        function renderCart() {
            DOM.cartItemsContainer.innerHTML = '';
            let total = 0;
            let totalItems = 0;
            if (state.cart.length === 0) {
                DOM.cartItemsContainer.innerHTML = '<p class="info-message">O seu carrinho está vazio.</p>';
            } else {
                state.cart.forEach(item => {
                    total += item.price * item.quantity;
                    DOM.cartItemsContainer.innerHTML += `
                        <div class="cart-item">
                            <img src="${item.image_url}" alt="${item.name}">
                            <div class="cart-item-info">
                                <div class="cart-item-title">${item.name}</div>
                                <div class="cart-item-price">${formatCurrency(item.price)}</div>
                                <div class="quantity-controls">
                                    <button data-id="${item.id}" class="quantity-decrease">-</button>
                                    <span>${item.quantity}</span>
                                    <button data-id="${item.id}" class="quantity-increase">+</button>
                                </div>
                            </div>
                            <button class="close-btn remove-from-cart" data-id="${item.id}">&times;</button>
                        </div>`;
                });
            }
            state.cart.forEach(item => totalItems += item.quantity);
            DOM.cartTotal.textContent = formatCurrency(total);
            DOM.cartCountBadge.textContent = totalItems;
            DOM.cartCountBadge.style.display = totalItems > 0 ? 'flex' : 'none';
            DOM.checkoutBtn.disabled = totalItems === 0;
        }

        async function fetchAndPopulate(tableName, selectElementIds, valueField = 'id', textField = 'name') {
            const { data, error } = await supabase.from(tableName).select(`${valueField}, ${textField}`);
            if (error) { console.error(`Error fetching ${tableName}:`, error); return; }
            const selectElements = Array.isArray(selectElementIds) ? selectElementIds.map(id => document.getElementById(id)) : [document.getElementById(selectElementIds)];
            selectElements.forEach(select => {
                if (select) {
                    const firstOption = select.options[0];
                    select.innerHTML = '';
                    if (firstOption) select.appendChild(firstOption);
                    data.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item[valueField];
                        option.textContent = item[textField];
                        select.appendChild(option);
                    });
                }
            });
        }

        async function fetchAndDisplayCategories() {
            const { data, error } = await supabase.from('categories').select('id, name, icon_class');
            if(error) { console.error("Error fetching categories:", error); return; }
            DOM.categoryIconsContainer.innerHTML = '';
            data.forEach(cat => {
                DOM.categoryIconsContainer.innerHTML += `
                    <div class="category-icon" data-category-id="${cat.id}">
                        <div><i class="fas ${cat.icon_class || 'fa-tag'}"></i></div>
                        <span>${cat.name}</span>
                    </div>
                `;
            });
        }

        async function handleAddOrEditProduct(e) { /* Implementação existente sem alterações */ }
        async function fetchUserProfile(user) { /* Implementação existente sem alterações */ }
        async function fetchInitialData(user) { /* Implementação existente sem alterações */ }
        function updateUIForUser() { /* Implementação existente sem alterações */ }
        function updateAccountPanel() { /* Implementação existente sem alterações */ }
        function renderOverallPanel(isSellerMode) { /* Implementação existente sem alterações */ }
        function renderBuyerPanel(panelId) { /* Implementação existente sem alterações */ }
        function renderVendorPanel(panelId) { /* Implementação existente sem alterações */ }
        function renderProductCard(product) { /* Implementação existente sem alterações */ }
        async function fetchAndDisplayProducts() { /* Implementação existente sem alterações */ }
        async function fetchAndDisplayFeatured() { /* Implementação existente sem alterações */ }
        async function fetchAndDisplayFavorites() { /* Implementação existente sem alterações */ }
        async function fetchMyProducts() { /* Implementação existente sem alterações */ }
        async function fetchMyReviews() { /* Implementação existente sem alterações */ }
        async function fetchAndDisplayPurchases() { /* Implementação existente sem alterações */ }
        async function openContactModal(productId) { /* Implementação existente sem alterações */ }
        function openReviewModal(orderId, productId, sellerId) { /* Implementação existente sem alterações */ }
        function openTopUpModal() { /* Implementação existente sem alterações */ }
        async function handleTopUp(e) { e.preventDefault(); /* Implementação existente sem alterações */ }
        function openWithdrawModal() { /* Implementação existente sem alterações */ }
        async function handleWithdraw(e) { e.preventDefault(); /* Implementação existente sem alterações */ }
        async function handleReviewSubmit(e) { e.preventDefault(); /* Implementação existente sem alterações */ }
        async function toggleFavorite(productId) { /* Implementação existente sem alterações */ }
        async function deleteProduct(productId) { /* Implementação existente sem alterações */ }
        function editProduct(productId) { /* Implementação existente sem alterações */ }
        function openVerificationModal(sealType) { /* Implementação existente sem alterações */ }
        async function handleVerificationSubmit(e) { /* Implementação existente sem alterações */ }

        function initEventListeners() {
            DOM.themeToggleBtn.addEventListener('click', toggleTheme);
            DOM.closeAuthBtn.addEventListener('click', closeAuthModal);
            DOM.loginForm.addEventListener('submit', (e) => { e.preventDefault(); login(DOM.loginForm.querySelector('#login-email').value, DOM.loginForm.querySelector('#login-password').value); });
            DOM.registerForm.addEventListener('submit', handleRegister);
            DOM.logoutBtn.addEventListener('click', signOut);
            DOM.recoveryForm.addEventListener('submit', handlePasswordRecovery);
            DOM.updatePasswordForm.addEventListener('submit', handleUpdatePassword);
            DOM.addProductForm.addEventListener('submit', handleAddOrEditProduct);
            DOM.closeContactModalBtn.addEventListener('click', () => DOM.contactModalOverlay.style.display = 'none');
            DOM.forgotPasswordLink.addEventListener('click', (e) => { e.preventDefault(); switchAuthView('password-recovery-view'); });
            DOM.backToLoginLink.addEventListener('click', (e) => { e.preventDefault(); switchAuthView('login-view'); });
            DOM.accountTypeBtns.forEach(btn => { btn.addEventListener('click', () => { DOM.accountTypeBtns.forEach(b => b.classList.remove('active')); btn.classList.add('active'); document.getElementById('register-account-type').value = btn.dataset.type; }); });
            DOM.authTabBtns.forEach(btn => { btn.addEventListener('click', () => { const view = btn.dataset.tab; if(view) switchAuthView(view); }); });
            DOM.cartIcon.addEventListener('click', () => DOM.cartModalOverlay.style.display = 'flex');
            DOM.closeCartBtn.addEventListener('click', () => DOM.cartModalOverlay.style.display = 'none');

            DOM.btnNextStep.addEventListener('click', () => {
                const firstName = DOM.registerForm.querySelector('#register-first-name').value;
                const lastName = DOM.registerForm.querySelector('#register-last-name').value;
                const dob = DOM.registerForm.querySelector('#register-dob').value;
                const email = DOM.registerForm.querySelector('#register-email').value;
                const password = DOM.registerForm.querySelector('#register-password').value;
                const confirm = DOM.registerForm.querySelector('#register-confirm').value;

                if (!firstName || !lastName || !email || !dob) {
                    alert('Por favor, preencha todos os campos obrigatórios.');
                    return;
                }
                if (password.length < 6) {
                    alert('A senha deve ter no mínimo 6 caracteres.');
                    return;
                }
                if (password !== confirm) {
                    alert('As senhas não coincidem!');
                    return;
                }
                DOM.registerPanel1.classList.remove('active');
                DOM.registerPanel2.classList.add('active');
            });

            DOM.btnPrevStep.addEventListener('click', () => {
                DOM.registerPanel2.classList.remove('active');
                DOM.registerPanel1.classList.add('active');
            });

            document.body.addEventListener('click', async (e) => {
                // NOVO: Lógica para mostrar/ocultar a senha
                if (e.target.classList.contains('toggle-password')) {
                    const passwordInput = e.target.previousElementSibling;
                    if (passwordInput.type === 'password') {
                        passwordInput.type = 'text';
                        e.target.classList.remove('fa-eye');
                        e.target.classList.add('fa-eye-slash');
                    } else {
                        passwordInput.type = 'password';
                        e.target.classList.remove('fa-eye-slash');
                        e.target.classList.add('fa-eye');
                    }
                    return; // Sai da função para não interferir com outros cliques
                }
                
                // Restante da lógica de cliques
                const productCard = e.target.closest('[data-product-id]');
                if (e.target.classList.contains('btn-add-to-cart')) {
                    if (productCard) {
                        showLoader();
                        const { data } = await supabase.from('products').select('*').eq('id', productCard.dataset.productId).single();
                        hideLoader();
                        if(data) addToCart(data);
                    }
                } else if (e.target.closest('.product-image, .featured-image')) {
                    if(productCard) openContactModal(productCard.dataset.productId);
                } else if (e.target.closest('.favorite-icon')) {
                    toggleFavorite(parseInt(e.target.closest('.favorite-icon').dataset.productId));
                } else if (e.target.closest('.btn-edit')) {
                    editProduct(parseInt(e.target.closest('.btn-edit').dataset.productId));
                } else if (e.target.closest('.btn-delete')) {
                    deleteProduct(parseInt(e.target.closest('.btn-delete').dataset.productId));
                } else if (e.target.closest('.category-icon')) {
                    const catIcon = e.target.closest('.category-icon');
                    const catId = catIcon.dataset.categoryId;
                    state.currentFilters.categoryId = catId;
                    DOM.categoryFilter.value = catId;
                    fetchAndDisplayProducts();
                    document.querySelectorAll('.category-icon').forEach(i => i.classList.remove('active'));
                    catIcon.classList.add('active');
                } else if (e.target.closest('.btn-review')) {
                    const btn = e.target.closest('.btn-review');
                    openReviewModal(btn.dataset.orderId, btn.dataset.productId, btn.dataset.sellerId);
                }
            });
            DOM.cartItemsContainer.addEventListener('click', (e) => { const id = parseInt(e.target.dataset.id); if (!id) return; if (e.target.classList.contains('quantity-increase')) { const item = state.cart.find(i => i.id === id); if(item) updateCartQuantity(id, item.quantity + 1); } else if (e.target.classList.contains('quantity-decrease')) { const item = state.cart.find(i => i.id === id); if(item) updateCartQuantity(id, item.quantity - 1); } else if (e.target.classList.contains('remove-from-cart')) { removeFromCart(id); } });
            document.querySelectorAll('#buyer-bottom-nav .nav-item').forEach(item => { item.addEventListener('click', () => { if (!state.currentUser && item.dataset.panel !== 'buyer-panel') { openAuthModal(); return; } document.querySelectorAll('#buyer-bottom-nav .nav-item').forEach(i => i.classList.remove('active')); item.classList.add('active'); renderBuyerPanel(item.dataset.panel); }); });
            document.querySelectorAll('#vendor-bottom-nav .nav-item').forEach(item => { item.addEventListener('click', () => { document.querySelectorAll('#vendor-bottom-nav .nav-item').forEach(i => i.classList.remove('active')); item.classList.add('active'); renderVendorPanel(item.dataset.panel); }); });
            DOM.switchToVendorBtn.addEventListener('click', () => renderOverallPanel(true));
            DOM.searchInput.addEventListener('input', () => { clearTimeout(searchTimeout); searchTimeout = setTimeout(() => { state.currentFilters.name = DOM.searchInput.value.trim(); fetchAndDisplayProducts(); }, 500); });
            DOM.categoryFilter.addEventListener('change', () => { state.currentFilters.categoryId = DOM.categoryFilter.value; fetchAndDisplayProducts(); });
            DOM.locationFilter.addEventListener('change', () => { state.currentFilters.locationId = DOM.locationFilter.value; fetchAndDisplayProducts(); });
            DOM.copyCodeBtn.addEventListener('click', () => { if(state.userProfile?.referral_code) navigator.clipboard.writeText(state.userProfile.referral_code).then(() => alert('Código de Padrinho copiado!')); });
            DOM.reviewForm.addEventListener('submit', handleReviewSubmit);
            DOM.closeReviewModalBtn.addEventListener('click', () => DOM.reviewModalOverlay.style.display = 'none');
            DOM.checkoutBtn.addEventListener('click', () => alert("Funcionalidade de checkout em implementação. Requer Edge Functions para segurança."));
            DOM.topUpBtn.addEventListener('click', openTopUpModal);
            DOM.withdrawBtn.addEventListener('click', openWithdrawModal);
            DOM.closeTopUpModalBtn.addEventListener('click', () => DOM.topUpModalOverlay.style.display = 'none');
            DOM.closeWithdrawModalBtn.addEventListener('click', () => DOM.withdrawModalOverlay.style.display = 'none');
            DOM.topUpForm.addEventListener('submit', handleTopUp);
            DOM.withdrawForm.addEventListener('submit', handleWithdraw);
            DOM.verificationActions.addEventListener('click', (e) => {
                if(e.target.matches('button[data-seal-type]')) {
                    openVerificationModal(e.target.dataset.sealType);
                } else if (e.target.matches('#pay-seal-btn')) {
                    alert("A funcionalidade de pagamento de selo requer uma função de backend segura para ser implementada.");
                }
            });
            DOM.verificationForm.addEventListener('submit', handleVerificationSubmit);
            DOM.closeVerificationModalBtn.addEventListener('click', () => DOM.verificationModalOverlay.style.display = 'none');

            function setupLocationSelectors() {
                const countrySelect = document.getElementById('register-country');
                const provinceSelect = document.getElementById('register-province');
                const municipalitySelect = document.getElementById('register-municipality');
                const phonePrefixSpan = document.getElementById('phone-prefix-display');

                Object.keys(locationData).forEach(country => {
                    const option = document.createElement('option');
                    option.value = country;
                    option.textContent = country;
                    countrySelect.appendChild(option);
                });

                countrySelect.addEventListener('change', () => {
                    const selectedCountry = countrySelect.value;
                    provinceSelect.innerHTML = '<option value="">Selecione uma província</option>';
                    municipalitySelect.innerHTML = '<option value="">Primeiro, selecione uma província</option>';
                    municipalitySelect.disabled = true;

                    if (selectedCountry && locationData[selectedCountry]) {
                        const countryInfo = locationData[selectedCountry];
                        phonePrefixSpan.textContent = countryInfo.prefix;
                        countryInfo.provincias.forEach(prov => {
                            const option = document.createElement('option');
                            option.value = prov.nome;
                            option.textContent = prov.nome;
                            provinceSelect.appendChild(option);
                        });
                        provinceSelect.disabled = false;
                    } else {
                        provinceSelect.disabled = true;
                    }
                });

                provinceSelect.addEventListener('change', () => {
                    const selectedCountry = countrySelect.value;
                    const selectedProvinceName = provinceSelect.value;
                    municipalitySelect.innerHTML = '<option value="">Selecione um município</option>';

                    if (selectedProvinceName && locationData[selectedCountry]) {
                        const countryInfo = locationData[selectedCountry];
                        const selectedProvinceData = countryInfo.provincias.find(p => p.nome === selectedProvinceName);

                        if (selectedProvinceData) {
                            selectedProvinceData.municipios.forEach(mun => {
                                const option = document.createElement('option');
                                option.value = mun;
                                option.textContent = mun;
                                municipalitySelect.appendChild(option);
                            });
                            municipalitySelect.disabled = false;
                        }
                    } else {
                        municipalitySelect.disabled = true;
                    }
                });
            }
            setupLocationSelectors();
        }

        async function initApp() {
            showLoader();
            loadTheme();
            loadCartFromLocalStorage();
            initEventListeners();
            await Promise.all([
                fetchAndPopulate('locations', ['product-location', 'location-filter']),
                fetchAndPopulate('categories', ['product-category', 'category-filter']),
                fetchAndDisplayCategories()
            ]);

            supabase.auth.onAuthStateChange(async (event, session) => {
                hideLoader();
                if (event === 'PASSWORD_RECOVERY') {
                    openAuthModal('update-password-view');
                } else if (event === 'SIGNED_IN') {
                    await fetchInitialData(session.user);
                    closeAuthModal();
                } else if (event === 'SIGNED_OUT') {
                    state.currentUser = null;
                    state.userProfile = null;
                    state.userFavorites.clear();
                    updateUIForUser();
                    await fetchAndDisplayProducts();
                    await fetchAndDisplayFeatured();
                }
            });

            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                 updateUIForUser();
                 await fetchAndDisplayProducts();
                 await fetchAndDisplayFeatured();
                 hideLoader();
            }
        }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
